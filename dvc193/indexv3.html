	<!-- @fryford - Data Visualisation Centre - Office for National Statistics -->
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="lib/idangerous.swiper.css">
    <link rel="stylesheet" href="lib/jquery-ui-1.10.4.custom.min.css">
    <link rel="stylesheet" href="lib/style-chosen.css">
    <link rel="stylesheet" href="lib/jquery.ui.labeledslider.css">
    
	<script type="text/javascript" src="lib/modernizr.custom.56904.js"></script>
    <script type="text/javascript" src="lib/webtrends.js"></script>
    <script src="lib/d3.v3.min.js" charset="utf-8"></script>
    <script src="lib/topojson.min.js"></script>
    <script src="lib/d3.tip.js"></script>
    <script src="lib/jquery-1.10.1.min.js"></script>
    <script src="lib/jquery-ui-1.10.4.custom.min.js"></script>
    <script src="lib/idangerous.swiper-2.1.min.js"></script>
    <script src="lib/idangerous.swiper.hashnav.js"></script>
    <script src="lib/chosen.jquery.js"></script>
    <script src="lib/jquery.ui.labeledslider.js"></script>
    <script src="lib/jquery.ui.touch-punch.min"></script>

<style>

html, body, div, span, applet, object, iframe,
h1, h2, h3, h4, h5, h6, p, blockquote, pre,
a, abbr, acronym, address, big, cite, code,
del, dfn, em, img, ins, kbd, q, s, samp,
small, strike, strong, sub, sup, tt, var,
b, u, i, center,
dl, dt, dd, ol, 
fieldset, form, label, legend,
table, caption, tbody, tfoot, thead, tr, th, td,
article, aside, canvas, details, embed, 
figure, figcaption, footer, header, hgroup, 
menu, nav, output, ruby, section, summary,
time, mark, audio, video
{
	margin: 0;
	padding: 0;
	border: 0;
	font-size: 100%;
	font: 'open_sansregular';
	vertical-align: baseline;
	
}

		html {
			height:100%;	
		}

		@font-face {
			font-family: 'open_sanslight';		
			src: url('./lib/OpenSans-Light-webfont.woff') format('woff');
			font-weight: normal;
			font-style: normal;
		
		}
		
		@font-face {
			font-family: 'open_sansitalic';		
			src: url('./lib/OpenSans-Italic-webfont.woff') format('woff');
			font-weight: normal;
			font-style: normal;
		
		}
		
		@font-face {
			font-family: 'open_sansregular';		
			src: url('./lib/OpenSans-Regular-webfont.woff') format('woff');
			font-weight: normal;
			font-style: normal;
		
		}
		
		@font-face {
			font-family: 'open_sanssemibold';		
			src: url('./lib/OpenSans-Semibold-webfont.woff') format('woff');
			font-weight: normal;
			font-style: normal;
		
		}
	
	
		
	   body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; 
        font-size: 14px;
		margin:0px auto;
		height:100%;
		background:rgb(250,250,250);

      }
	  
	  #container {
		position:relative;
		margin: 0px auto;
		height:710px;
		width:940px;	
		box-shadow: 0px 0px 6px rgb(221, 221, 221);

	  }
	  
	  #mapDiv {

		position:absolute;
		display:block;
		top:65px;
		left:0;
		background-color:#fff;
		width:100%;
		height: -webkit-calc(100% - 80px);
		height: -ms-calc(100% - 80px);
		height: -moz-calc(100% - 80px);
		height: calc(100% - 80px);
		overflow:hidden;

	  }
	  
	  #mapDiv svg {
	
	  }
	  
	  #sigLabel {
	 	position:absolute;
		z-index:20;
		width:130px;
		height:16px;
		bottom:2px;
		right:355px;
		background: rgba(255,255,255,0.8);
		padding:5px 5px;
		color:#ca5359;
		font-family: 'open_sansregular';
		font-size:11px;
	  }
	  
	  #sigline {
	 	position:absolute;
		display:block;
		width:20px;
		height:2px;
		border-top:2px #ca5359 dashed;
		top:13px;
	  }
	  
	  
	  #siglink {
	 	position:absolute;
		left:30px;
	  }
	  
	  #storytag {
		position:absolute;
		left:-28px;
		top:45%;
		color:#fff;
		background-color:#5381ca;
		padding: 7px 10px;
		cursor:pointer;
		transform: rotate(90deg);
		-moz-transform: rotate(90deg);  /* FF3.5+ */
		-o-transform: rotate(90deg);  /* Opera 10.5 */
		-webkit-transform: rotate(90deg);  /* Saf3.1+, Chrome */   
		  
	  }
	  

	  
	  #mapSVG {
		position:absolute;
		top:0px;
		left:370px;
		width:calc(100% - 370px);
		height: 100%;
	
	  }
  
	  path.mapPoly {
        stroke: #666;
        stroke-width: 0.05%;
		fill:#eee;
      }
	  
	  .polyhigh {
		stroke: #666;
		stroke-width: 0.05%;
		fill:#fff;
	  }
	  
      path.mapPoly:hover {

		fill:#fff;
      }
	  
	  #box	{
		fill:#fff;

	  }
	  
	  #mapGraticule	{
		fill:#2A3F00;
		stroke:#C9C9C9;
		stroke-dasharray: 2,2;
		stroke-width:0.1%;  
	  }
	  
	 .mapArcs	{
	
	  }
	  
	 .mapArcsLow	{
		fill:none;
		stroke:#53bcca;
		stroke-width:0.1%; 
		stroke-linecap:round; 
		opacity:0.3;
  
	  }
	  
	  .mapArcsHigh	{
		fill:none;
		opacity:1;
		stroke:#ca6153;
		stroke-width:0.3%;
		stroke-linecap:round;
		stroke-dasharray: 5,3;
		
	  }
	  
	  
	  .mapArcsLowP	{
		fill:none;
		stroke:#666;
		stroke-width:0.1%; 
		stroke-linecap:round; 
		opacity:0.3;
  
	  }
	  
	  .mapArcsLowN	{
		fill:none;
		stroke:#ca6153;
		stroke-width:0.1%; 
		stroke-linecap:round; 
		opacity:0.3;
  
	  }
	  
	  .mapArcsHighP	{
		fill:none;
		opacity:1;
		stroke:#ca6153;
		stroke-width:0.3%;
		stroke-linecap:round;
		stroke-dasharray: 5,3;
		
	  }
	  
	  .mapArcsHighN	{
		fill:none;
		opacity:1;
		stroke:#666;
		stroke-width:0.3%;
		stroke-linecap:round;
		stroke-dasharray: 5,3;
		
	  }
	  
	  
	  .mapArcsSel	{
		  
		fill:none;
		opacity:1;
		stroke: #666;
		stroke-width:0.3%;
		stroke-linecap:round;
		
	  }
	  
	  
	  #flowtype {
		position:absolute;
		top:16px;
		right:-2px;
	  }
	
/* Swiper content */
	  
.device {
  width: 370px;
  height: 100%;
  position: relative;
  background: rgba(250,250,250,0.7);
  z-index:+5;
}
.device .arrow-left {
  background: url(images/prev.png) no-repeat left top;
  display:inline-block;
  width: 67px;
  height: 65px;
  margin-left:20px;
  opacity:0.7;

}
.device .arrow-right {
  background: url(images/next.png) no-repeat left bottom;
  display:inline-block;
  width: 67px;
  height: 65px;
  margin-left:20px;
  margin-right:100px;
  opacity:0.7;
  
}

.device .arrow-right:hover {
	opacity:1;
}

.device .arrow-left:hover {
	opacity:1;
}


.close {
  background: url(images/close.png) no-repeat left bottom;
  display:block;
  font-family: 'open_sansregular';
  line-height: 15px;
  width: 30px;
  height: 29px;
  margin-left:35px;
  padding-left: 38px;
  opacity:0.5;
  
}

.close:hover {
	opacity:1;
}

a.close {
	text-decoration: none;
}

a:hover {
	cursor:pointer;
}


.swiper-container {
  height: 600px;
  width: 370px;
  
  position:relative;
  left:0px;
}
.content-slide {
  width:340px;
  height: 450px;
  font-family: 'open_sansregular';
  font-size:13px;
  padding: 20px;
  color: #666;
}
.title {
  font-size: 20px;
  margin-bottom: 10px;
}
.pagination {
  position: absolute;
  left: 0;
  text-align: center;
  bottom:5px;
  width: 30%;
}
.swiper-pagination-switch {
  display: inline-block;
  width: 10px;
  height: 0px;
  border-radius: 10px;
  background: #999;
  box-shadow: 0px 1px 2px #555 inset;
  margin: 0 3px;
  cursor: pointer;
}
.swiper-active-switch {
  background: #fff;
}

#arealab {
	font-family: 'open_sansregular';
	font-size:20px;
	color:#666;
	margin: 0px 0px 5px 5px;
	padding-right:20px;
	line-height:1.45;
}

#subarealab{
	font-family: 'open_sanslight';
	font-size:18px;
	color:#666;
}

#currtime {
	position:absolute;
	right:385px;
	top:3px;
	font-family: 'open_sanslight';
	font-size:30px;
	color:#5381ca;
	z-index:11;
}


#chartText {
	position:absolute;
	top:0px;
	left:211px;
	font-family: 'open_sansregular';
	font-size:18px;
	color:#fff;
	margin: 8px 0px 5px -13px;
	
}




/* CSS for chart */

#toppanel {
	
	width:100%;
	height:65px;
	position:absolute;
	left:0;
	top:0px;
	border-bottom: 3px #5381ca solid; 
	background-color:#fff;
	z-index:10;
	
}

#titlepanel {
	position:absolute;
	top:10px;	
	font-family: 'open_sanslight';
	font-size:26px;
	padding-left:20px;
	color:#666;
	line-height:0.9;
}

#titlepanel span{

	font-family: 'open_sansitalic';
	font-size:12px;
	
}

#panel {
	
	width: 350px;
	height:100%;
	position:absolute;
	bottom:0px;
	display:none;
	right:0px;
	background-color:rgba(250,250,250,0.9);
	z-index:8;
	position: absolute;
	
}

#panelsel {
	
	width: 350px;
	height:215px;
	position:absolute;
	top:0px;
	display:none;
	right:0px;
	background-color:rgba(250,250,250,0.9);
	z-index:8;
	position: absolute;
	
}

#nosel {
	
	width: 310px;
	height:15px;
	position:absolute;
	top:74px;
	padding:3px 7px;
	background-color:#5381CA;
	font-family: 'open_sansregular';
	display:none;
	left:8px;
	color:#fff;
	z-index:8;
	position: absolute;
	
}

#areaopts {
	position:absolute;
	top:0px;
	right:73px;	
}

#subselection {
	position:absolute;
	top:35px;
	
}

#preselzoom {
	position:absolute;
	top:120px;
	left:10px;

}

#preselzoom p {
	position:absolute;
	left:97px;
	top:66px;
	width:250px;
	font-family: 'open_sansregular';
	color:#666;

}

#london {
	position:absolute;
	top:0px;
	left:240px;
	height:80px;
	width:80px;
	background-color: #ccc; 
	border: 2px solid #5381ca;
	cursor:pointer;
	opacity:0.7;
}

#london:hover {
	opacity:1;
	
}

#selectbtn {

	position:absolute;
	top:0px;
	right:0px;
	height:20px;
	width:100px;
	background-color:rgba(250,250,250,0.9);
	color:#5381ca;
	cursor:pointer;
	font-family: 'open_sansregular';
	padding: 5px 5px;
	tab-index:;
}

#closebtn {

	position:absolute;
	top:0px;
	right:0px;
	height:20px;
	width:340px;
	background-color:#5381ca;
	color:#fff;
	cursor:pointer;
	font-family: 'open_sansregular';
	padding: 5px 5px;
}


#leftp {
	
	width:330px;
	height:130px;
	position:absolute;
	left:5px;
	top:285px;
	border-top: #A0A0A4 1px dashed;
}


#lefttop {
	
	width:330px;
	height:33px;
	position:absolute;
	left:5px;
	top:43px;
	border-bottom: #A0A0A4 2px solid;
	z-index:10;	
	
}

#middlep {
	
	width:330px;
	height:172px;
	position:absolute;
	left:5px;
	top:445px;
	border-top: #A0A0A4 1px dashed;
}



#middletop {
	
	width:190px;
	height:18px;
	position:absolute;
	left:10px;
	top:420px;
	color:#666;
	padding:5px 0px 0px 0px;
	text-align:left;
	text-transform:lowercase;
}


#rightp {
	
	width:330px;
	height:172px;
	position:absolute;
	left:5px;
	top:80px;
	/*border-top: #A0A0A4 1px dashed;*/
	
}

#righttop {
	
	width:130px;
	height:18px;
	position:absolute;
	left:10px;
	top:430px;
	color: #666;
	padding:5px 0px 0px 0px;
	text-align:left;
}


.leftLabels {

	position:absolute;
	width:120px;
	font-family:'open_sansregular';
	font-size:20px;
	text-transform:lowercase;
	
}

.leftFigures {

	position:absolute;
	color:#666;	
	font-family:'open_sansregular';
	font-size:20px;
	
}

#sliderTime {
	
	width:30%;
	height:50px;
	position:absolute;
	left:100px;
	top:3px;
	display:none;
	background-color:rgba(255,255,255,0.6);
	z-index:9;
	opacity:0.3;
	padding-right:20px;
	padding-left:20px;
	
}


#sliderInOut {
	
	width:200px;
	height:50px;
	position:absolute;
	right:10px;
	top:170px;
	background-color:rgba(255,255,255,0.6);
	z-index:9;
	padding-right:20px;
	padding-left:20px;
	
}

#sliderlabel {
	
	width:200px;
	height:50px;
	position:absolute;
	right:0px;
	top:-50px;
	color:#666;
	font-family: 'open_sansregular';
	font-size:14px;
}


#sliderTime:hover {
	opacity:1;
	z-index:10;
}

		#slider
		{
			position:absolute;
			display: block;
			left:0px;
			top:0px;
			
		}


		#foot {
			position:absolute;
			bottom:0px;
			left:0px;
			height:15px;
			width:100%;

				
		}
		
		#foot a {
			font-size:10px;
			float:right;
			margin-right:10px;
			color: #5381ca;
			font-family: 'open_sansregular';
			
			
		}
		
		#source {
			position:absolute;
			bottom:0px;
			left:0px;
			height:15px;
			width:50%;

				
		}
		
		#source a {
			font-size:10px;
			float:left;
			margin-left:10px;
			color: #5381ca;
			font-family: 'open_sansregular';
			
		}
		
		a {
			text-decoration:none;
		}
		
		
		a:hover {
			text-decoration: underline;	
		}

	/******* Chart CSS **********/
		body
		{
			font-family:Arial, Helvetica, sans-serif;	
			position: relative;
   			width: 100%;
		}
		
		
		#mainChart
		{
			position:absolute;
			top:-40px;
			left:10px;
			width:340px;
			height:210px;
	
		}
		
		#mainChart line 
		{
			stroke:#ccc;		
		}

		#mainChart text
		{
			fill:#666;		
		}
		
		button
		{
			margin: 10px 10px 0 10px;
		}
		
		#chartTitle
		{
			font-size:18px;
		}
		
		#chartSubtitle, #chartUnits
		{
			font-size:12px;
			fill:#666;
		}
		
		#dataSource, #footNote, .credit
		{
			font-size:10px;
		}
		
		#txtTime
		{
			font-size:28px;
			font-weight:bold;
			fill:#5381ca;
			font-family: 'robotothin';
			text-anchor:middle;
			
		}
		
		.yLabel {
			
			fill:#999;
			font-size:12px;
			height:20px;
			width:30px;
		}
		
		.barText {
			text-anchor:end;
			fill:#666;	
			font-family:Arial, Helvetica, sans-serif;	
			font-size:11px;
		}
		
		.barText2 {
			text-anchor:start;
			fill:#666;
			font-family:Arial, Helvetica, sans-serif;	
			font-weight:bold;
			font-size:11px;
		}
		
		.axis path,
		.axis line
		{
			fill: none;
			stroke: #ccc;
			stroke-width: 0.1%
		}
		
		.axis text
		{
			fill:#666;
			font-size:11px;
			font-family:Arial, Helvetica, sans-serif
		}
		
		.grid path,
		.grid line
		{
			fill: none;
			stroke: #cccccc;
			stroke-width: 0.1%
		}
		
		/*don't need to display the text on the secondary grid element*/
		.grid text
		{
			display:none;
		}
		
		.barMarker
		{
			fill:steelblue;
			fill-opacity:0.5;
		}
		
		.intBar
		{
			fill-opacity:0;
			
		}
		
       .intBar:hover
	   { 
            fill:#ccc; 
            fill-opacity:0.8;         
                        
        } 
		
		.intBarActive
		{
			fill:#ccc;
			fill-opacity:0.8;	
		}
		
		.chartBarSel
		{
			fill:red;	
		}
		
		.chartBarsHigh
		{
			fill:#ca5359;	
		}
		
		.chartBarsHighP
		{
			fill:#ca5359;	
		}
		
		.chartBarsHighN
		{
			fill:#666;	
		}
		
		.chartBarsLowP
		{
			fill:#ca5359;
			fill-opacity:0.6;	
		}
		
		.chartBarsLowN
		{
			fill:#ccc;
			fill-opacity:0.6;		
		}
		
		.chartBars
		{
			fill:#53bcca;
		}
		
		.selText
		{
			fill:black;	
			text-anchor:end;
		}
		
		
		
		
	/*Time Chart CSS */

		
		#mainStackChart
		{
			position:absolute;
			top:-75px;
			left:0px;
			width:313px;
			height:270px;
			padding:5px;
	
		}
		
	
		
		
		.tick .major {
			stroke-width: 0.1%;
			stroke: #CCC;
			fill:none;
			
				
		}
		
		.legend {
		
			font-size:11px;
			fill:#666;
		}
		
		
		#controls {
		position:absolute;
		top:15px;
		right:0px;
		width:300px;
		display:none;
		
		}

#sel {
 width:280px;	
}


/* Social */		
#fullscreen {
	position:absolute;
	top:10px;
	right:50px;
	height:30px;
	width:50px;
	background-color:#FF1FAA;	
	z-index:40;
}


#headingbar {

			

			float:left;
			height: 30px;
			width: 100%;
			margin: 0px auto;
			background:#fff;
			z-index:+1;	
			 
		}
		
	
		#twitter {
			display:block;
			margin:2px 5px 5px 2px;
			width:25px;
			height:25px;
			float:right;
			background-position: right;
			background:transparent url('./images/twitblue.png') center top no-repeat;
			opacity:0.5;
		}
		
		#twitter:hover {
			
			opacity:1;
		}

		#face {
			display:block;
			margin:2px 5px 5px 2px;
			width:25px;
			height:25px;
			float:right;
			background-position: right;
			background:transparent url('./images/faceblue.png') center top no-repeat;
			opacity:0.5;

		}
		
		#face:hover {
			
			opacity:1;
		
		}
		
		
		#full {
			display:block;
			margin:5px 12px 5px 2px;
			width:20px;
			height:20px;
			float:right;
			background-position: right;
			background:transparent url('./images/fullblue.png') center top no-repeat;
			opacity:0.5;
		}
		
		#full:hover {
			
			opacity:1;
		
		}
		
		#embed {
			display:block;
			margin:2px 5px 5px 2px;
			width:25px;
			height:25px;
			float:right;
			background-position: right;
			background:transparent url('./images/embedblue.png') center top no-repeat;
			opacity:0.5;
		}
		
		#embed:hover {
			
			opacity:1;
		
		}


		#embedbox{

			position:absolute;
			right:0px;
			top:0px;
			height:35px;
			width:300px;
			display:none;
			background:rgba(98,177,246,0.8);
			z-index:10;
			padding:15px;

		}

		

		#embedbox p {
			
			font-size:12px;
			color:#fff;
	
		}
		
		#embedurl {
			width:285px;
			color:#666;
		}
		
		#close {
			display:block;
			margin:-5px -5px 5px 5px;
			width:14px;
			height:14px;
			position:absolute;
			top:13px;
			right:10px;
			background-position: right;
			background:transparent url('./images/closewhite.png') center top no-repeat;

		}


/*Map zoom buttons */

		.zoom-control-zoom a, .zoom-control-layers-toggle {
		background-position: 50% 50%;
		background-repeat: no-repeat;
		display: block;
		}
		.zoom-control-zoom a {
		width: 22px;
		height: 22px;
		text-align: center;
		text-decoration: none;
		color: #5381ca;
		}
		
		.zoom-control-zoom-in {
		cursor:pointer;
		font: bold 18px/24px Arial, Helvetica, sans-serif;
		}
		
		.zoom-control-zoom-in:hover {
			color: #fff;
			background-color: #5381ca;	
		}
		.zoom-bar-part-top {
		}
		.zoom-bar-part {
		background-color: rgba(255, 255, 255, 0.8);
		border-bottom: 1px solid #aaa;
		}
		
		.zoom-control-zoom-out {
		cursor:pointer;
		font: bold 23px/20px Tahoma, Verdana, sans-serif;
		}
		
		.zoom-control-zoom-out:hover {
			color: #fff;
			background-color: #5381ca;	
		}
		.zoom-bar-part-bottom {
		border-bottom: none;
		}
		
		.zoom-container {
		margin-left: 13px;
		margin-top: 20px;
		position: absolute;
		left: 0px;
		top: 0px;
		}
		
		.zoom-bar {
		
		border: 1px solid #59a4da;
		}
		.zoom-popup-pane, .zoom-control {
		cursor: auto;
		}
		.zoom-control {
		float: left;
		clear: both;
		}
		.zoom-control {
		
		z-index: 7;
		pointer-events: auto;
		}


		.d3-tip {
		  line-height: 1;
		  font-size: 12px;
		  width:80px;
		  padding: 6px;
		  background: rgba(255, 255, 255, 0.9);
		  color: #666;
		  font-family: 'open_sansregular';
		  z-index:13;
		}
		
		.d3-tip:after {
		  box-sizing: border-box;
		  display: inline;
		  font-size: 10px;
		  width: 100%;
		  line-height: 1;
		  color:  rgba(255, 255, 255, 0.8);
		  content: "\25BC";
		  position: absolute;
		  text-align: center;
		}

		.d3-tip.n:after {
		  margin: -1px 0 0 0;
		  top: 100%;
		  left: 0;
		}
		
		
		
/*IE8*/

		#ieMsg{
			position:absolute;
			margin: 0px auto;
			
			
			/*top:0px;*/
	
			width:940px;
		}
		
		#suptext {
			height:100px;
			z-index:2;
			width:300px;
			margin: 0px auto;
			padding:50px;
			background-color:#F2F5FA;
			border: 1px solid #186685;
			position:relative;
			top:140px;
			left:300px;
			
		}
		
		 
		#suptext a{
			font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
			font-size:14px;
			color:#186685;
		}
		
		
		#altImage{
			top:-200px;
			position:relative;
			left:0px;
		}

		.slice:hover {
			opacity:0.7;	
		}
		
		#key p{
			position:absolute;
			top:-10px;
			right:140px;
			width:350px;
			text-align:right;
			font-family: 'open_sansregular';
			font-size:12px;
			#666;
		}
		
		#key {
			position:absolute;
			display:block;
			right:-130px;
			bottom:20px;
			/*background:rgba(98,177,246,0.05);*/
			border-radius:5px;
			z-index:1;
			
		}
		
		#key path {
		  display: none;
		}
		
		#key line {
		  stroke: #000;
		  shape-rendering: crispEdges;
		}
		
		#key g {
		
			font-size:11px;
			fill:#666;
			
		}
		
		#key rect {
			stroke:#666;
			stroke-width:0.5px;
			z-index:+1;
		}
		
		.semibold {
			font-family: open_sanssemibold;
			color:#404040;
			font-size:14px;
		}

</style>


<title>Internal migration flow map - Office for National Statistics</title>

</head>

<body>

<div id="container" style="display:none">

<div id="toppanel">
    <div id="headingbar">

        <a href='javascript:post2Twitter()' id="twitter" title="share me on twitter"></a>
        <a href='javascript:makeFace()' id="face" title="share me on facebook"></a>
        <a href='javascript:showEmbed()' id="embed" title="please embed me!"></a>
        <a href='javascript:requestFullScreen()' id="full" title="go fullscreen"></a>
         
    </div>

    <div id="embedbox" display='none'>
    		<a href='javascript:embedHide()' id="close" title="close box"></a>
            <p>Paste HTML to embed in website</p>
			<input type='text' id='embedurl' name='iframe'/>
    </div>



</div>
<div id="mapDiv">
    
    
 	<div id="panel">
    	
    	<div id="leftp"></div>
        <div id="lefttop"></div>
    	<div id="middlep"><div id="chart"></div></div>
        <div id="middletop">inward migration</div>
    	<div id="rightp">

        </div>
        <!--<div id="righttop">flow breakdown</div>-->
    </div>
    
    <div id="panelsel">
    </div>
    
 

  <div class="device">
    
    <div class="swiper-container">
      <div class="swiper-wrapper">
        <div class="swiper-slide" data-hash="slide1">
          <div class="content-slide">
            <!--<p class="title">The headlines</p>-->
            <p>A total of <span class="semibold">11,260,336</span> working residents in the UK commuted from one local authority to another for work. But, how far do people commute to work? Which local authorities have a higher number of people out-commuting to work elsewhere? Where do the <span class="semibold">residents in my local authority work</span>, and where does the <span class="semibold">working population in my local authority live</span>?<br><br>Find out this and more with these interactive maps.<br><br>
The 406 local authorities in England, Northern Ireland, Scotland, and Wales are shown in the map on the right. <br><br>You can see that we have marked 3 extremely different cases - a local authority with:<br>
<ul>
<li>A high number of net-commuters (in-commuters minus out-commuters)</li>
<li>A low number of net-commuters</li>
<li>Similar number of workers in-commuting and out-commuting to/from it.</li>
</ul>
Hover over the areas to see which is which.
</p>
          </div>
			<a class="arrow-right" href="#"></a>
            <div class="pagination"></div>
            <a class="close" href="#">
            Skip introduction
            </a>
        </div>
        <div class="swiper-slide" data-hash="slide2">
          <div class="content-slide">
            <p class="title">Increase or decrease?</p>
    <p>Does your areas population increase or decrease because of commuting patterns? The map highlights <span class="semibold" style="color:blue">(in blue)</span> the local authorities that have <span class="semibold">more in-commuters than out-commuters;</span> that is: more people coming to work in that area than leave to work elsewhere.<br><br>
</p>
          </div>
            <a class="arrow-left" href="#"></a> 
			<a class="arrow-right" href="#"></a>
            <div class="pagination"></div>
            <a class="close" href="#">
            Skip introduction
            </a>
         </div>
         
        <div class="swiper-slide" data-hash="slide3">
          <div class="content-slide">
            <p class="title">Out-commuters</p>
            <p>What <span class="semibold">proportion</span> of the workers living in your local authority work in your local authority, and what proportion <span class="semibold">commute out</span> to a different local authority?<br><br>The map currently highlights <span class="semibold" style="color:blue">(in blue)</span> the areas where over 50 per cent of workers commute out to work. Use the slider to change the threshold.<br><br> The share of out-commuters is defined as the number of out-commuters in a local authority divided by the total number of residents (who are in employment) in that local authority. For example, here is a breakdown for <span class="semibold">East Renfrewshire</span> (Scotland). You can see that 66% of the resident population commute out of the area.<img src="images/erenfrew.png">
</p>
          </div>
            <a class="arrow-left" href="#"></a>
            <a class="arrow-right" href="#"></a>
			<div class="pagination"></div>
            <a class="close" href="#">
            Skip introduction
            </a>
        </div>
        
        <div class="swiper-slide" data-hash="slide4">
          <div class="content-slide">
            <p class="title">In-commuters</p>
            <p>The map on the right highlights the local authorities with highest share of in-commuters. Use the slider to change the threshold.<br><br>The people that work in a local authority are its workplace population. The share of in-commuters is defined as the number of in-commuters in a local authority divided by its workplace population. For example, 56% of the workplace population in <span class="semibold">Manchester</span> commute in from different local authorities.<br><bt><img src="images/manchester.png">
		  </p>
          </div>
            <a class="arrow-left" href="#"></a>
            <a class="arrow-right" href="#"></a> 
			<div class="pagination"></div>
            <a class="close" href="#">
            Skip introduction
            </a>
        </div>
        
        
        <div class="swiper-slide" data-hash="slide5">
          <div class="content-slide">
            <p class="title">The London magnet</p>
            <p>The map now shows the share of working residents in each local authority that work in Greater London. There are 19 local authorities were over 20% of working residents commute to London, a further 23 local authorities have over 10% of working residents commuting to London and 21 more local authorities have between 5%-10% of working residents commuting to London. <a onClick="drawmap2();"> Greater London</a><br><br>We can also  <a onClick="drawmap1();">switch</a> to look at the share of working residents in each local authority that work in <a onClick="drawmap1();">Inner London</a>. There are 21 local authorities were over 20% of working residents commute to Inner London, and 3 of them are outside of Outer London: Epping Forest (East of England), Brentwood (East of England), and Elmbridge (South East).
		  	</p>
          </div>
            <a class="arrow-left" href="#"></a>
    		<a class="arrow-right" href="#"></a> 
			<div class="pagination"></div>
            <a class="close" href="#">
            Skip introduction
            </a>
        </div>
		
		
		<div class="swiper-slide" data-hash="slide6">
          <div class="content-slide">
            <p class="title">Time for you to go to work</p>
            <p>The local authorities with more than 70% of in-commuters in their workforce are all in Inner London. For example, 79% of the workplace population in Tower Hamlets commute in from different local authorities; the map on the right shows where these workers live.
            
            Once you <a href="javascript:closeStory()">close</a> this introduction you can use the interactive map to explore commuting patterns in more detail for your area.<br><br>The areas highlighted in <span style="color:#ca6153">red</span> show the significant relationships for the area - significant given the distribution of values for the area, using a method adapted from  <a href="http://onlinelibrary.wiley.com/doi/10.1111/j.1538-4632.1977.tb00591.x/abstract">Holmes and Haggett (1977).</a>
		  </p>
          </div>
            <a class="arrow-left" href="#"></a>
			<div class="pagination"></div>
            <a class="close" href="#">
            Close
            </a>
        </div>
		
      </div>
    </div>
    
  </div>
  

  



  
  
  
</div>

<div id="foot">
<a href="http://bit.ly/onsdatavis" target="_blank">See more by the ONS Data Visualisation Centre</a>
</div>
<div id="source">
<a href="http://www.ons.gov.uk/ons/rel/migration1/internal-migration-by-local-authorities-in-england-and-wales/index.html" target="_blank">Source & data: ONS, Internal Migration Estimates</a>
</div>
</div>

    
    <div id="ieMsg" style="display:none">
      
               
        <div id="suptext">
              <p class="IE_P">For a safer, faster, better experience online you should upgrade your browser. You will then be able to play with lovely interactive graphics such as this one.</p>
              <p> <a href="https://www.gov.uk/support/browsers" target="_blank">Find out more about browsers</a></p>
        </div>
          <div id="altImage"><img id="thumbNail" src="images/alt.png" alt="Thumbnail"></div>

    </div> 





<script>


var dvc = {};


if (Modernizr.inlinesvg) {
$(document).ready(function(){	

	$("#container").show();
	
	dvc.width = 940,
    dvc.height = 635,
	dvc.clipMode = false,
	dvc.flow = 'flow0'
	dvc.fix = false;
	dvc.xPadding=38;
	dvc.yPadding=65;
	
	dvc.chartWidth = 260,
	dvc.chartHeight = 130,
	dvc.gapRatio = 0,
	dvc.timeIndex = 0;
	dvc.selection = false;
	
	dvc.storyover=false;
	dvc.firsttime=true; 
	dvc.ddselect=false;
	dvc.swiping = false;
	dvc.preselect = null;
	
	dvc.newviewminx = 200;
	dvc.newviewminy = -40;
	dvc.newviewWidth = 630;
	dvc.newviewHeight = 635;
	dvc.trans = [0,0];
	dvc.scale = 1;
	
	getParams();
	
	dvc.projectionFlat = d3.geo.mercator()
		.scale(15000)
		.translate([620,3000])
		.precision(1);

	dvc.projectionGlobe = d3.geo.orthographic()
	.rotate([2.3,-53.3])
    .scale(5600)
    .clipAngle(90)
    .precision(.1);

	dvc.projection = dvc.projectionFlat;

	dvc.path = d3.geo.path()
	.projection(dvc.projection);

	zoom = d3.behavior.zoom()
    	.scaleExtent([1, 20])
    	.on("zoom", move);


	dvc.svg = d3.select("#mapDiv").append("svg")
	.attr("id","mapSVG")
	.attr("viewBox", "200 -40 " + 630 + " "+ dvc.height)
	.append("g")
	.attr("id","zoomBox")
	.attr("transform","translate(0,0)");
	
		dvc.svg.append("rect").attr("id","box").attr("width",630).attr("x",180).attr("height",630).on("click",function(){
				if(dvc.fix ==true){
				dvc.fix=false; 
				removeSpider();
				}
				$('#areaselect').val("");
				$('#areaselect').trigger("chosen:updated");
			});  
	
	dvc.svg.append("g").attr("id","mapGraticule");
	dvc.svg.append("g").attr("id","mapPolygons");
	
	dvc.graticule = d3.geo.graticule()
                    .step([10, 10]);

	d3.select("#mapGraticule").append("path")
        .datum(dvc.graticule)
        .attr("class", "graticule")
        .attr("d", dvc.path);

		var filepth = 'geo/flow2.js';
	  
	  d3.json("geo/ukgeog.json", function(error, world) {
		d3.select("#mapPolygons").selectAll("path")
			.data(topojson.feature(world, world.objects.layer1).features)
			.enter()
			.append("path")
			.attr("d", dvc.path)
			.attr("class", "mapPoly")
			.attr("id", function(d) {return d.properties.CD})
			.attr("pointer-events","none");
		
		d3.json(filepth, function(error, json) {
			if (error) return console.log(error);
			dvc.flowdata=json;
			areaopt();
			getCentroids();
			
		}); 
		
     
	    dvc.globe2map = interpolatedProjection(dvc.projectionGlobe, dvc.projectionFlat);
  		dvc.map2globe = interpolatedProjection(dvc.projectionFlat, dvc.projectionGlobe);

		//d3.select("#S12000015").attr("class","").attr("fill","#fff").attr("stroke","#666").attr("stroke-width","0.05%").attr("pointer-events","none");

   });

   
 });
 
function getCentroids() {
			
			centr = []
			
			centr['UK'] = ['[-1.41,52.7]'];
			
			d3.selectAll(".mapPoly")
			.attr("data-cd", function(d,i) {
					if(d.properties.CD == 'UK')
					{return centr[d.properties.CD]} else 
					{return "[" + d3.geo.centroid(d) + "]"}
			});
			
		
		//Need to build an array of centroid pairings
		
		dvc.allcentroids = [];
				
		d3.selectAll(dvc.flowdata.ons.area).each(function(d,i){
			dvc.allcentroids.push(d3.select("#" + dvc.flowdata.ons.area[i]).attr("data-cd"));		
		});
		
   		if(dvc.storyover=='true') {
			closeStory();
		}
			
}


function areaopt () {

d3.select("#panel").append("div").attr("id","selectbtn").text("area selection").on("click",function(){$("#panelsel").show("slide", {direction: "top" },"slow")});
//$( "#tabs" ).tabs();

var countryzip = d3.zip(dvc.flowdata.ons.areaname, dvc.flowdata.ons.area);

	console.log(dvc.flowdata.ons.areaname);
	console.log(dvc.flowdata.ons.area);
	console.log(countryzip);

var countryzip2 = countryzip.sort(function(b, a){ return d3.descending(a[0], b[0]) });

var top = d3.select("#toppanel");
	
	controls = top.append("div").attr("id","controls");

	var sidesel = d3.select("#panelsel");
	
	sidesel.append("div").attr("id","nosel").append("p").text("no flows between these two areas");
	
	sidesel.append("div").attr("id","closebtn").text("Close").on("click",function(){$("#panelsel").hide("slide", {direction: "top" },"slow")});
	
	d3.select("#closebtn").append("a").on("click", function(){$("#panelsel").hide("slide", {direction: "top" },"slow")}).attr("id","close");
	
	areaopts = sidesel.append("div").attr("id","areaopts");
	
	var optns = areaopts.append("div").attr("id","sel").append("select")
		.attr("id","areaselect")
		.attr("style","width:330px")
		.attr("class","chosen-select");
	
	optns.append("option")
		.attr("value","first")
		.text("");
	
	optns.selectAll("p").data(countryzip2).enter().append("option")
		.attr("value", function(d){ return d[1]}) /* Optional */
		.text(function(d){ return d[0]});
		
	
	$('#areaselect').chosen({width: "330px",allow_single_deselect: true,placeholder_text_single:"Select a Local Authority"}).on('change',function(evt,params){
		
						var subsel = d3.select("#subselection");
		
						if(typeof params != 'undefined') {
						
						dvc.fixareacode = this.value;
						sel(this.value);	
						fixSpider(this.value);		
						}
						else {
						dvc.fix=false;
						enablehover();
						removeSpider();
						subsel.remove();
						
						}
	});
	
	
	var preselzoom = sidesel.append("div").attr("id","preselzoom");
	
	preselzoom.append("p").text("...or zoom straight to");
	
	preselzoom.append("div")
		.attr("id","london")
		.append("img")
		.attr("src","images/london.png")
		.on("click",function(){
			d3.select("#zoomBox").transition().duration(2000).attr("transform","translate(-100,-211)");
			setTimeout(function() {d3.select("#mapSVG").transition().duration(2000).attr("viewBox","475 238 80 80")},2001);	
			
		});
	
	flowselect()
	
	top.append("h2")
		.attr("id","titlepanel")
		.html(dvc.flowdata.ons.name + '<br><span>' + dvc.flowdata.ons.subname + '</span>');
}




 
function subareaopt () {

	var top = d3.select("#toppanel");
	
	var countryzip = d3.zip(dvc.flowdata.ons.areaname, dvc.flowdata.ons.area);


	var countryzip2 = countryzip.sort(function(b, a){ return d3.descending(a[0], b[0]) });
	
	var suboptns = areaopts.append("div").attr("id","subselection").append("select")
		.attr("id","subsel")
		.attr("style","width:330px")
		.attr("class","chosen-select");
	
	suboptns.append("option")
		.attr("value","first")
		.text("");
	
	suboptns.selectAll("p").data(countryzip2).enter().append("option")
		.attr("value", function(d){ return d[1]}) // Optional 
		.text(function(d){ return d[0]});
		

	suboptns.selectAll("p").data(countryzip2).enter().append("option")
		.attr("value", function(d){ return d[1]}) // Optional 
		.text(function(d){ return d[0]});

	
	$('#subsel').chosen({width: "330px",allow_single_deselect: true,placeholder_text_single:"...and if you like, choose a sub-selection"}).on('change',function(evt,params){
							
						if(typeof params != 'undefined') {
						
							if(dvc.selection==true) {
								d3.select("#int" + dvc.currentbar).attr("class","intBar")
								unhighmatch()
							}
									
							dvc.currentbar=this.value;
							freeze();
							
							}
							else {
								
								d3.select("#int" + dvc.currentbar).attr("class","intBar")
								unhighmatch();
								enablehover();
								revertsel(dvc.fixareacode);
							}
						});
	
}

function freeze () {
		var freeze = d3.select("#int" + dvc.currentbar);
		if(freeze.empty()){
			$("#nosel").show();
			$('#subsel').val("");
		    $('#subsel').trigger("chosen:updated");
			setTimeout(function(){$("#nosel").hide()},3000);
		} else {
			freeze.attr("class","intBarActive")
			highlightarc();
			dvc.selection = true;
			disablehover();
		}
}


function disablehover () {
	
	d3.selectAll(".polyhigh").attr("pointer-events","none");
	d3.selectAll(".mapPoly").attr("pointer-events","none");
	d3.selectAll(".intBar").attr("pointer-events","none");
	d3.selectAll(".intBarActive").attr("pointer-events","none");
		
}


function enablehover () {
	//dvc.selection = false;
	d3.selectAll(".mapPoly").attr("pointer-events","all");
	d3.selectAll(".intBarActive").attr("class","intBar");
	d3.selectAll(".intBar").attr("pointer-events","all");
	
}

function timeSlider() {
	
if(dvc.flowdata.ons.timeLabels.length >1){

dvc.timeP = dvc.flowdata.ons.timeLabels[dvc.timeIndex];

dvc.time = d3.select("#mapDiv").append("div").attr("id","currtime");

dvc.time.attr("x",10).attr("y",40).text(dvc.timeP);

d3.select("#mapDiv").append("div").attr("id","sliderTime").append("div").attr("id","slider");

$('#slider').labeledslider({min:eval(dvc.flowdata.ons.timeLabels[0]), max:eval(dvc.flowdata.ons.timeLabels[dvc.flowdata.ons.timeLabels.length - 1]), value:eval(dvc.flowdata.ons.timeLabels[dvc.timeIndex]), tickInterval:1, step:1, change:function(event,ui){
	
	var value = $(event.target).labeledslider( "option", "value" );
	
	dvc.timeP=value;
    changetext(value);
  if(dvc.selection==true) {
	  	freeze();
  }
	updateHash();
		
}}); 

dvc.timeMin = 0;
dvc.timeMax = dvc.flowdata.ons.timeLabels.length - 1;
}
}

function zoomControls() {
	
	zoomcontrols = d3.select("#mapDiv")
		.append('div').attr("class","zoom-container zoom-control-zoom zoom-bar zoom-control");
	
	zoomcontrols.append("a").attr("class","zoom-control-zoom-in zoom-bar-part zoom-bar-part-top").attr("title","Zoom in").text("+").on("click",zoomin);
	zoomcontrols.append("a").attr("class","zoom-control-zoom-out zoom-bar-part zoom-bar-part-bottom").attr("title","Zoom out").text("-").on("click",zoomout);
	
}

function zoomin(){
	var currview = d3.select("#mapSVG").attr("viewBox");
	var viewminx = parseFloat((currview.split(" "))[0]);
	var viewminy = parseFloat((currview.split(" "))[1]);
	var viewWidth = parseFloat((currview.split(" "))[2]);
	var viewHeight = parseFloat((currview.split(" "))[3]);
	
	viewcenX = viewminx + (viewWidth/2)
	viewcenY = viewminy + (viewHeight/2)

	dvc.newviewWidth =viewWidth*0.5;
	dvc.newviewHeight = viewHeight*0.5;
	
	dvc.newviewminx = viewcenX - (dvc.newviewWidth/2);
	dvc.newviewminy = viewcenY - (dvc.newviewHeight/2);
	
	d3.select("#mapSVG").transition().duration(500).attr("viewBox", dvc.newviewminx + " " + dvc.newviewminy + " " + dvc.newviewWidth  + " " + dvc.newviewHeight)
	
	updateHash();
	
}

function zoomout(){
	
	var currview = d3.select("#mapSVG").attr("viewBox");
	

	var viewminx = parseFloat((currview.split(" "))[0]);
	var viewminy = parseFloat((currview.split(" "))[1]);
	var viewWidth = parseFloat((currview.split(" "))[2]);
	var viewHeight = parseFloat((currview.split(" "))[3]);
	
	viewcenX = viewminx + (viewWidth/2)
	viewcenY = viewminy + (viewHeight/2)

	dvc.newviewWidth = viewWidth*2;
	dvc.newviewHeight = viewHeight*2;
	
	dvc.newviewminx = viewcenX - (dvc.newviewWidth/2);
	dvc.newviewminy = viewcenY - (dvc.newviewHeight/2);
	
	d3.select("#mapSVG").transition().duration(500).attr("viewBox", dvc.newviewminx + " " + dvc.newviewminy + " " + dvc.newviewWidth  + " " + dvc.newviewHeight)

	updateHash();
}




function changetext(){
	
    var timeInd = dvc.flowdata.ons.timeLabels.indexOf(JSON.parse('"' + dvc.timeP + '"'));
	dvc.timeIndex = timeInd;
	dvc.ddselect=true;
	
	dvc.time.attr("x",30).attr("y",40).text(dvc.timeP);
	d3.select("#arealab").html(dvc.fixareaname);
	d3.select("#subarealab").html("total");
	
	
	if(dvc.fix==true) {
		
		
		removeSpiderFix(); 
		
		dvc.areacode=dvc.fixareacode;
		dvc.position = dvc.flowdata.ons.area.indexOf(dvc.areacode);
		dvc.areaname = dvc.flowdata.ons.areaname[dvc.position];

		
		arrays()
		
	};
	
	
}

function highlight(area){
	dvc.areacode = area;
	dvc.position = dvc.flowdata.ons.area.indexOf(dvc.areacode);
	dvc.areaname = dvc.flowdata.ons.areaname[dvc.position];
	
	dvc.fix=true;
	dvc.ddselect=true;
	removeSpiderFix();
	
	arrays();
}


function rotate(p) {
	
	d3.transition()
      .duration(2500)
      .tween("rotate", function() {
        var r = d3.interpolate(dvc.projection.rotate(),[-p[0], -p[1]]);
        return function(t) {
          dvc.projection.rotate(r(t));
		  dvc.svg.selectAll("path").attr("d", dvc.path);
        };
    });
	
}

function defaultRotate() {
	
	if(dvc.view != undefined) { 
		d3.select('#mapSVG').transition().duration(1000).style("left","0px").attr("viewBox", dvc.newviewminx + " " + dvc.newviewminy + " " + dvc.newviewWidth  + " " + dvc.newviewHeight);
	} else {
		d3.select('#mapSVG').transition().duration(1000).style("left","0px").attr("viewBox", "200 -40 " + 630 + " "+ dvc.height);
	}

	d3.select("#zoomBox").transition().duration(1000).attr("transform", "translate(" + dvc.trans  + ") scale(" + dvc.scale + ")");
}
	
function interpolatedProjection(a, b) {
    var projection = d3.geo.projection(raw).scale(1),
    center = projection.center,
    translate = projection.translate,
    clip = projection.clipAngle,
    α;
    
    function raw(λ, φ) {
      var pa = a([λ *= 180 / Math.PI, φ *= 180 / Math.PI]), pb = b([λ, φ]);
      return [(1 - α) * pa[0] + α * pb[0], (α - 1) * pa[1] - α * pb[1]];
    }
    
    projection.alpha = function(_) {
      if (!arguments.length) return α;
      α = +_;
      var ca = a.center(), cb = b.center(),
      ta = a.translate(), tb = b.translate();
      center([(1 - α) * ca[0] + α * cb[0], (1 - α) * ca[1] + α * cb[1]]);
      translate([(1 - α) * ta[0] + α * tb[0], (1 - α) * ta[1] + α * tb[1]]);
      if (dvc.clipMode === true) {clip(180 - α * 90);}
      return projection;
    };
    
    delete projection.scale;
    delete projection.translate;
    delete projection.center;
    return projection.alpha(0);
  }

	function move() {
	 
	  dvc.svg.attr("transform", "translate(" + d3.event.translate  + ") scale(" + d3.event.scale + ")");
		
	  dvc.trans = d3.event.translate;
	  dvc.scale = d3.event.scale;
	  
	  updateHash();
	}

	function stopped() {
		  if (d3.event.defaultPrevented) d3.event.stopPropagation();
	}

  function trans() {
	  defaultRotate();
	 
 
	   d3.select("#lefttop").append("p").attr("id","arealab").html("");
	   d3.select("#leftp").append("div").attr("id","subarealab").html("");
					leftp = d3.select("#leftp");
					
					leftp.append('div').selectAll('p')
							.data(dvc.flowdata.ons.dataType)
							.enter()
							.append('p')
							.attr('class', 'leftLabels')
							.style('text-align','right')
							.style('left', '10px')
							.style('color', '#53bcca')
							.style('top', function(d,i){ return ((i *25) + 38) + 'px';})
							.text(function(d){ return d; });

	 				leftp.selectAll('h1')
							.data(dvc.flowdata.ons.dataType)
							.enter()
							.append('p')
							.attr('class', 'leftFigures')
							.style('right', '70px')
							.style('color', '#53bcca')
							.style('top', function(d, i){ return ((i *25) + 38) + 'px';});
					
					var leftfig = d3.selectAll(".leftFigures");
					
							leftfig.append("span").attr('class',"leftno").attr('id', function(d,i) {return "leftfig" + i}).text("0")
							leftfig.append("span").attr('class',"leftunit").text("");
								 
		}

	function projectionTween(projection0, projection1) {
	  return function(d) {
		var t = 0;

	   var projection = d3.geo.projection(project).scale(1);
			//.translate([width / 2, height / 2]);
	
		var path = d3.geo.path()
			.projection(projection);
	
		function project(λ, φ) {
		  λ *= 180 / Math.PI, φ *= 180 / Math.PI;
		  var p0 = projection0([λ, φ]), p1 = projection1([λ, φ]);
		  return [(1 - t) * p0[0] + t * p1[0], (1 - t) * -p0[1] + t * -p1[1]];
		}
	
		return function(_) {
		  t = _;
		  return path(d);
		};
	  };
	}

	function changecont(slideno) {
	var disablebutton =	d3.selectAll(".arrow-left, .arrow-right, .close");
	
		if(slideno == "1"){
			d3.select('#mapSVG').attr("viewBox", "200 -40 " + 630 + " "+ dvc.height);
			d3.select('#zoomBox').attr("transform","translate(0,0) scale(1)")
			
			
			disablebutton.style("opacity","0.1");
			setTimeout(function()
				{dvc.swiping = false;
				disablebutton.style("opacity","0.7");
				 
			},5000);
			dvc.svg.call(zoom);

			var zoomcont = d3.select(".zoom-container");
				  
			if(zoomcont.empty() == true) {
			  zoomControls()
			  d3.select(".zoom-container").style("margin-left","380px")
			} else {zoomcont.style("margin-left","380px")}
			
			
			dvc.swiping = false;
			d3.selectAll(".mapPoly").attr("pointer-events","none").style("fill","").style("stroke","#666").on("mouseover", null).on("mouseout", null);
			
			setTimeout(function(){d3.select('#mapSVG').transition().duration(3000).attr("viewBox", "480 240 80 80");
			d3.select('#zoomBox').transition().duration(2000).attr("transform","translate(-111,-205) scale(1)")},2000);
			
			d3.selectAll(dvc.flowdata.ons.area).each(function(d,i){
							
							d3.select("#"+ dvc.flowdata.ons.area[i])
								.attr("data-net",function() {return dvc.flowdata.ons.totals[i][2]})
								.attr("data-nm",function() {return dvc.flowdata.ons.areaname[i]});
			
			});
			
			dvc.nformat = d3.format("0,000");	
			
			var tip = d3.tip()
			  .attr('class', 'd3-tip')
			  .offset([0, 0])
			  .html(function(d) {
				return d3.select(this).attr("data-nm") + ":<br>" + dvc.nformat(d3.select(this).attr("data-net"));
			  });
			  
			d3.select("#E09000030").style("fill","#5381ca").call(tip);
			d3.select("#E09000032").style("fill","#bdca53").call(tip);
			d3.select("#E07000066").style("fill","#ca6153").call(tip);
			
			d3.selectAll("#E09000030")
				.attr("pointer-events","all")
				.on("mouseover", tip.show)
				.on("mouseout", tip.hide);
				
			d3.selectAll("#E09000032")
				.attr("pointer-events","all")
				.on("mouseover", tip.show)
				.on("mouseout", tip.hide);
				
			d3.selectAll("#E07000066")
				.attr("pointer-events","all")
				.on("mouseover", tip.show)
				.on("mouseout", tip.hide);
			
			
			
		}
	
		if(slideno == "2"){
			d3.select("#sliderInOut").remove();
			d3.selectAll(".mapPoly").attr("pointer-events","none").style("fill","").style("stroke","#666").on("mouseover", null).on("mouseout", null);
			dvc.swiping = true;
			
			disablebutton.style("opacity","0.1");
			setTimeout(function()
				{dvc.swiping = false;
				disablebutton.style("opacity","0.7");
				 
			},4300);
			
			if(dvc.fix==true){
				  dvc.fix = false;
				  
				   removeSpider();
			}
			d3.select("#zoomBox").transition().duration(1000).attr("transform", "translate(0,0) scale(1)");
			d3.select('#mapSVG').transition().duration(3000).attr("viewBox", "200 -40 " + 630 + " "+ dvc.height);
			//d3.select('#zoomBox').transition().duration(2000).attr("transform","translate(0,0)");
			
			var tip = d3.tip()
			  .attr('class', 'd3-tip')
			  .offset([0, 0])
			  .html(function(d) {
				return d3.select(this).attr("data-nm") + ": " + dvc.nformat(d3.select(this).attr("data-net"));
			});
			  
			d3.select('#mapPolygons').call(tip);
			
			d3.selectAll(".mapPoly")
				.attr("pointer-events","all")
				.on("mouseover", tip.show)
				.on("mouseout", tip.hide);

			var x = d3.zip(dvc.flowdata.ons.area,dvc.flowdata.ons.totals);
			
			d3.selectAll(".device").attr("pointer-events","none");
			
			d3.selectAll(dvc.flowdata.ons.area).each(function(d,i){
							
							d3.select("#"+ dvc.flowdata.ons.area[i])
								.transition()
								.delay(i*10)
								.duration(400)
								
								.style("fill",function(){
										if(dvc.flowdata.ons.totals[i][2]>=0){return "#5381ca"}
										else {return "#eee"};
								})
								.style("stroke",function(){
										if(dvc.flowdata.ons.totals[i][2]>=0){return "#fff"}
										else {};
								});
			});
			
		}
		
		if(slideno == "3"){
			
			var keys = d3.select("key");
			if(keys.empty() == false) {
				keys.remove();
			}
			
			d3.select("#sliderInOut").remove();
			d3.selectAll(".mapPoly").attr("pointer-events","none").style("fill","").style("stroke","#666").on("mouseover", null).on("mouseout", null);
			d3.select("#zoomBox").transition().duration(1000).attr("transform", "translate(0,0) scale(1)");
			d3.select('#mapSVG').transition().duration(3000).attr("viewBox", "200 -40 " + 630 + " "+ dvc.height);
			dvc.swiping = true;
			disablebutton.style("opacity","0.1");
			setTimeout(function(){
				dvc.swiping = false
				disablebutton.style("opacity","0.7");
				},3000);
			
			var propout = [];
			
			d3.selectAll(dvc.flowdata.ons.totalsuse).each(function(d,i){
					var propouttie = Math.round((dvc.flowdata.ons.totalsuse[i][3]/d3.sum(dvc.flowdata.ons.totalsuse[i]))*100);
				
					propout.push(propouttie);
				
			});

			var propout = eval(propout);
			
			var propoutarea = d3.zip(propout,dvc.flowdata.ons.area);
			
			var propoutareasort = propoutarea.sort(function(a, b) {return d3.descending(a[0], b[0])});
			
			
			d3.selectAll(propoutareasort).each(function(d,i){
							d3.select("#"+ propoutareasort[i][1])
								.transition()
								.delay(i*10)
								.duration(400)
								
								.style("fill",function(){
										if(propoutareasort[i][0]>=50){return "#5381ca"}
										else {return "#eee"};
								})
								.style("stroke",function(){
										if(propoutareasort[i][1] == "S12000011"){return "red"}
										else if(propoutareasort[i][0]>=50){return "#fff"}
										else {};
								});
				
			});
			
			
			
			d3.select("#mapDiv").append("div").attr("id","sliderInOut").append("div").attr("id","sliderinorout");
			d3.select("#sliderinorout").append("div").attr("id","sliderlabel").html("% of usual working residents who commute out: <span class='semibold'>>50%</span>")

			$('#sliderinorout').labeledslider({min:0, max:100, value:50, tickInterval:20, step:1, change:function(event,ui){
				var value = $(event.target).labeledslider( "option", "value" );
				
							d3.selectAll(propoutareasort).each(function(d,i){
							d3.select("#"+ propoutareasort[i][1])								
								.style("fill",function(){
										if(propoutareasort[i][0]>=value){return "#5381ca"}
										else {return "#eee"};
								})
								.style("stroke",function(){
										if(propoutareasort[i][1] == "S12000011"){return "red"}
										if(propoutareasort[i][0]>=value){return "#fff"}
										else {};
								});
				
							});
							
							d3.select("#sliderlabel").html("% of usual working residents who commute out: <span class='semibold'>>" + value + "%</span>")
			}}); 			




		}
		
		
		if(slideno == "4"){
			d3.select("#sliderInOut").remove();
			d3.select("#key").remove();
			d3.selectAll(".mapPoly").attr("pointer-events","none").style("fill","").style("stroke","#666").on("mouseover", null).on("mouseout", null);
			d3.select('#mapSVG').transition().duration(3000).attr("viewBox", "200 -40 " + 630 + " "+ dvc.height);
			d3.select("#zoomBox").transition().duration(1000).attr("transform", "translate(0,0) scale(1)");
			dvc.swiping = true;
			disablebutton.style("opacity","0.1");
			setTimeout(function(){
				dvc.swiping = false
				disablebutton.style("opacity","0.7");
				},3000);
		
			
			var propout = [];
			
			d3.selectAll(dvc.flowdata.ons.totalsuse).each(function(d,i){
					var propouttie = Math.round((dvc.flowdata.ons.totalswork[i][4]/d3.sum(dvc.flowdata.ons.totalswork[i]))*100);
				
					propout.push(propouttie);
				
			});

			var propout = eval(propout);
			
			var propoutarea = d3.zip(propout,dvc.flowdata.ons.area);
			
			var propoutareasort = propoutarea.sort(function(a, b) {return d3.descending(a[0], b[0])});
			
			
			d3.selectAll(propoutareasort).each(function(d,i){
							d3.select("#"+ propoutareasort[i][1])
								.transition()
								.delay(i*10)
								.duration(400)
								
								.style("fill",function(){
										if(propoutareasort[i][0]>=50){return "#5381ca"}
										else {return "#eee"};
								})
								.style("stroke",function(){
										if(propoutareasort[i][0]>=50){return "#fff"}
										else {};
								});
				
			});
			
			
			
			d3.select("#mapDiv").append("div").attr("id","sliderInOut").append("div").attr("id","sliderinorout");
			d3.select("#sliderinorout").append("div").attr("id","sliderlabel").html("% of workplace population who commute in: <span class='semibold'>>50%</span>")
			
			$('#sliderinorout').labeledslider({min:0, max:100, value:50, tickInterval:20, step:1, change:function(event,ui){
				var value = $(event.target).labeledslider( "option", "value" );
				
							d3.selectAll(propoutareasort).each(function(d,i){
							d3.select("#"+ propoutareasort[i][1])								
								.style("fill",function(){
										if(propoutareasort[i][0]>=value){return "#5381ca"}
										else {return "#eee"};
								})
								.style("stroke",function(){
										if(propoutareasort[i][0]>=value){return "#fff"}
										else {};
								});
				
							});
							
							d3.select("#sliderlabel").html("% of workplace population who commute in: <span class='semibold'>>" + value + "%</span>")
			}}); 
						
			
			
			
			
		
			}

			if(slideno == "5"){
				
			disablebutton.style("opacity","0.1");
			setTimeout(function()
				{dvc.swiping = false;
				disablebutton.style("opacity","0.7");
				 
			},4000);
					
				d3.selectAll(".mapPoly").attr("pointer-events","none").style("fill","").style("stroke","#666").on("mouseover", null).on("mouseout", null);
				d3.select('#mapSVG').transition().duration(3000).attr("viewBox", "200 -40 " + 630 + " "+ dvc.height);
				d3.select('#zoomBox').transition().duration(2000).attr("transform","translate(0,0)");
				d3.select("#sliderInOut").remove();
				drawmap2();

			}
			
			
			if(slideno == "6"){
				
			disablebutton.style("opacity","0.1");
			setTimeout(function()
				{dvc.swiping = false;
				disablebutton.style("opacity","0.7");
				 
			},4000);
			
				d3.selectAll(".mapPoly").attr("pointer-events","none").style("fill","").style("stroke","#666").on("mouseover", null).on("mouseout", null);
				d3.select('#mapSVG').attr("viewBox", "200 -40 " + 630 + " "+ dvc.height);
				d3.select('#zoomBox').transition().duration(2000).attr("transform","translate(0,0)");
				
				
				
				d3.select("#key").remove();
				sel("E09000030");
				fixSpider("E09000030");
				
				setTimeout(function(){d3.select('#mapSVG').transition().duration(3000).attr("viewBox", "440 200 160 160");
				d3.select('#zoomBox').transition().duration(2000).attr("transform","translate(-111,-205) scale(1)")},2000);
				
			}
			

//			dvc.swiping = true;
//			disablebutton.style("opacity","0.1");
//			setTimeout(function(){
//				dvc.swiping = false
//				disablebutton.style("opacity","0.7");
//				},4000);
//			
//			d3.selectAll(".mapPoly").attr("pointer-events","none").style("fill","").style("stroke","#666").on("mouseover", null).on("mouseout", null);
//			d3.select("#zoomBox").transition().duration(2000).attr("transform","translate(-75,-168)");
//			setTimeout(function() {d3.select("#mapSVG").transition().duration(2000).attr("viewBox","443 198 162 160")},2001);
//			sel("E06000043");
//			fixSpider("E06000043");


		
	}
	
	function key(label){
			

		var svg = d3.select("#mapDiv").append("div")
			.attr("id", "key")
			.append("svg")
		    .attr("height", 350)
		    .attr("width",250);
			
		d3.select("#key").append("p").html(label);
			
		var color = d3.scale.threshold()
 		   .domain([0,1,5,10,20,44])
 		   .range(["#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c"]);

		y = d3.scale.linear()
		    .domain([0, 44]) /*range for data*/
		    .range([300, 0]); /*range for pixels*/
		
		var yAxis = d3.svg.axis()
		    .scale(y)
		    .orient("left")
    		.tickSize(15)
		    .tickValues(color.domain());
			
		var g = svg.append("g")
			.attr("transform", "translate(85,40)");
		
		g.selectAll("rect")
			.data(color.range().map(function(d, i) {
			  return {
				y0: i ? y(color.domain()[i]) : y.range()[0],
				y1: i < color.domain().length ? y(color.domain()[i+1]) : y.range()[1],
				z: d
			  };
			}))
		  .enter().append("rect")
			.attr("width", 8)
			.attr("y", function(d) { return d.y1; })
			.attr("height", function(d) { return d.y0 - d.y1; })
			.style("fill", function(d) { return d.z; });
		
		g.call(yAxis).append("text")
			.attr("id", "caption")
			.attr("x", -63)
			.attr("y", -20)
			.text("");
			
		g.append("rect")
			.attr("id","keybar")
			.attr("width",8)
			.attr("height",0)
			.attr("transform","translate(15,0)")
			.style("fill", "#ccc")
			.attr("y",y(0));

			
		}
	

	function drawmap1() {
		
	  var keys = d3.select("#key");
	  
	  if(keys.empty() == false) {
			keys.remove();
	  }
					
		var label = "% of usual working residents who<br>commute to work to Inner London";
		key(label);
		
					d3.selectAll(".mapPoly").attr("pointer-events","none").style("fill","").style("stroke","#666").on("mouseover", null).on("mouseout", null);
						var breaks1 = [44,20,10,5,1,0];
						
						var colors = ["#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c"];
						
						d3.selectAll(dvc.flowdata.ons.londonmap1).each(function(d,i){
														
							d3.select("#"+ dvc.flowdata.ons.londonmap1[i][0])
								.transition()
								.delay(i*10)
								.duration(300)
								.style("fill",function(){
										if(dvc.flowdata.ons.londonmap1[i][1]>=breaks1[1]){return colors[4]}
										else if(dvc.flowdata.ons.londonmap1[i][1]>=breaks1[2]){return colors[3]}
										else if(dvc.flowdata.ons.londonmap1[i][1]>=breaks1[3]){return colors[2]}
										else if(dvc.flowdata.ons.londonmap1[i][1]>=breaks1[4]){return colors[1]}
										else if(dvc.flowdata.ons.londonmap1[i][1]>=breaks1[5]){return colors[0]};
										//else {return "#eee"};
								});

					
						});
	}
	
	
	function drawmap2() {
	  var keys = d3.select("#key");
	  
	  if(keys.empty() == false) {
			keys.remove();
	  }
		
		var label = "% of usual working residents who<br>commute to work to Greater London";
		key(label);
		
				d3.selectAll(".mapPoly").attr("pointer-events","none").style("fill","").style("stroke","#666").on("mouseover", null).on("mouseout", null);
				
				var breaks1 = [44,20,10,5,1,0];
				
				var colors = ["#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c"];
				
				d3.selectAll(dvc.flowdata.ons.londonmap2).each(function(d,i){
										
					d3.select("#"+ dvc.flowdata.ons.londonmap2[i][0])
						.transition()
						.delay(i*10)
						.duration(300)
						.style("fill",function(){
								if(dvc.flowdata.ons.londonmap2[i][1]>=breaks1[1]){return colors[4]}
								else if(dvc.flowdata.ons.londonmap2[i][1]>=breaks1[2]){return colors[3]}
								else if(dvc.flowdata.ons.londonmap2[i][1]>=breaks1[3]){return colors[2]}
								else if(dvc.flowdata.ons.londonmap2[i][1]>=breaks1[4]){return colors[1]}
								else if(dvc.flowdata.ons.londonmap2[i][1]>=breaks1[5]){return colors[0]};
								//else {return "#eee"};
						});

			
				});
	
	
	}	
	
	
	function closeStory() {
			
	  $(".device").hide();
	  $("#controls").show("slide", {direction: "right" },"slow");
	  $("#panel").show("slide", {direction: "top" },"slow");
	  
	  timeSlider();
	  var zoomcont = d3.select(".zoom-container");
	  
	  if(zoomcont.empty() == true) {
	  zoomControls();
	  } else {zoomcont.transition().duration(2000).style("margin-left","13px")}
	  
	  $("#sliderTime").show("slide", {direction: "left" },"slow");
	  dvc.storyover=true;
	  trans();
	  
	  d3.select("#key").remove();
	  d3.select("#sliderInOut").remove();
	  
	  if(dvc.preflow != undefined) {
		  
		 dvc.flow= dvc.preflow; 
		 d3.select("#" + dvc.flow).attr("checked", "checked");
		 $("#flowtype").buttonset("refresh");

	  }
	  else {dvc.flow='flow0'};
	  
	  if(dvc.fix==true){
		  
		  dvc.fix = false;
		  removeSpider();
		  $('#areaselect').val("");
		  $('#areaselect').trigger("chosen:updated");
	  }
	  
	  if(dvc.preselect != null  && dvc.preselect != "undefined") {
		   
			sel(dvc.preselect);
			fixSpider(dvc.preselect);
	  }
	  
	  d3.selectAll(".mapPoly")
	    .attr("pointer-events","all")
		.style("fill","")
		.style("stroke","#666")
	    .on("mouseover", function(d) {return sel(d.properties.CD)})
		.on("mouseout", function(d) {return removeSpider()})
		.on("mousedown", function(d) {return fixSpider(d.properties.CD)});
	  
	  var siglabel = d3.select("#mapDiv").append("div").attr("id", "sigLabel")
	  
	  siglabel.append("div").attr("id","sigline");  
	  siglabel.append("a").attr("id","siglink").attr("href","http://onlinelibrary.wiley.com/doi/10.1111/j.1538-4632.1977.tb00591.x/abstract").attr("target", "_blank").text("significant flow");
	  setTimeout(function(){updateHash()},1000);
	  
	  d3.select("#mapDiv").append("div").attr("id", "storytag").text("show intro").on("click",openStory);
	
	}
	function openStory(){
		
		d3.select("#sigLabel").remove();
		d3.select("#storytag").remove();
		zoomcontrols.remove();
		d3.select("#sliderTime").remove();
		d3.select("#currtime").remove();
		d3.selectAll(".leftFigures").remove();
		$("#panelsel").hide();
	  $(".device").show();
	  $("#controls").hide("slide", {direction: "right" },"slow");
	  $("#panel").hide("slide", {direction: "top" },"slow");
		
		changecont(1);
		mySwiper.swipeTo(0);
		
		if(dvc.fix==true){
		  dvc.fix = false;
		  removeSpider();
		  $('#areaselect').val("");
		  $('#areaselect').trigger("chosen:updated");
	  }
	  
	 d3.select('#mapSVG').transition().duration(1000)
		.style("left","370px")
		.attr("viewBox", "200 -40 630 635");

	d3.select("#zoomBox").transition().duration(1000).attr("transform", "translate(0,0) scale(1)");
	
	}
	
	function flowselect(){
		
	d3.select("#controls")
		.append("form")
		.append("div")
		.attr("id","flowtype")
		.attr("left", dvc.width - 150 + "px");
		
	d3.selectAll(dvc.flowdata.ons.dataType).each(function(d,i){
		$('<input type="radio" name="radio" class="flowsel" id="flow' + i +'"/>').appendTo('#flowtype');
		$('<label for="flow' + i + '">' + dvc.flowdata.ons.dataType[i] + '</label>').appendTo('#flowtype');
		
	});
	
	d3.select("#" + dvc.flow).attr("checked", "checked");
		
	$("#flowtype").buttonset()
		.change(function() {	
		dvc.flow=$("#flowtype :radio:checked").attr("id");
		updateHash();
		dvc.flowname = $('#flowtype :radio:checked').next('label:first').text();
		d3.select('#middletop').text(dvc.flowname + ' migration');
		if(dvc.fix==true) {removeSpiderFix(); definearray();}
		if(dvc.selection==true) {
			freeze();
		}
	});
	
	
	}

	
	function projectionnext() {
		
		d3.transition()
    		.duration(1500)
    		.tween("rotate", function() {
      		var r = d3.interpolate(dvc.projection.rotate(), [280, -40]);
			return function(t) {
        	dvc.projection.rotate(r(t));
			dvc.svg.selectAll("path").attr("d", dvc.path);
			
      };
	  })
	}
	
	function projectionprev() {
		
		d3.transition()
    		.duration(1500)
    		.tween("rotate", function() {
      		var r = d3.interpolate(dvc.projection.rotate(), [70, -40]);
			return function(t) {
        	dvc.projection.rotate(r(t));
			dvc.svg.selectAll("path").attr("d", dvc.path);
			};
		})	
	}
	
	
	function sel(d) {
		
		dvc.areacode=d;
		dvc.position = dvc.flowdata.ons.area.indexOf(dvc.areacode);
		dvc.areaname = dvc.flowdata.ons.areaname[dvc.position];
		
		arrays();
	}
	
	function arrays() {
		
		if (dvc.fix==false || (dvc.fix==true && dvc.ddselect==true)) {
		
		dvc.ddselect=false;

		dvc.areaname = dvc.flowdata.ons.areaname[dvc.position];
		
		var into = dvc.flowdata.ons.dataValues[dvc.position];
		
		var out = [];
		
		var net = [];
		for(j=i=0; i<dvc.flowdata.ons.areaname.length; i++) {
			  out.push(dvc.flowdata.ons.dataValues[i][dvc.position]);
			  net[i]=[];
			  for(j=0; j<dvc.flowdata.ons.timeLabels.length; j++){
					net[i].push(dvc.flowdata.ons.dataValues[dvc.position][i][j] - dvc.flowdata.ons.dataValues[i][dvc.position][j]);
			  };
    	};
		
		dvc.infilter = d3.zip(into.map(function(value, index) {return value[dvc.timeIndex]}), dvc.flowdata.ons.area, dvc.allcentroids).filter(function(d) { return d[0] > 0; });
		dvc.outfilter = d3.zip(out.map(function(value, index) {return value[dvc.timeIndex]}), dvc.flowdata.ons.area, dvc.allcentroids).filter(function(d) { return d[0] > 0; });		
		dvc.netfilter = d3.zip(net.map(function(value, index) {return value[dvc.timeIndex]}), dvc.flowdata.ons.area, dvc.allcentroids).filter(function(d) { return d[0] != 0;});
	
		dvc.flow0time = into;
		dvc.flow1time = out;
		dvc.flow2time = net;
		
		dvc.flow0 = dvc.infilter.sort(function(a, b){ return d3.descending(a[0], b[0]) });/*IN*/
		dvc.flow1 = dvc.outfilter.sort(function(a, b){ return d3.descending(a[0], b[0]) });/*OUT*/
		dvc.flow2 = dvc.netfilter.sort(function(a, b){ return d3.descending(a[0], b[0]) });/*NET*/
		dvc.flownet = dvc.netfilter.slice().sort(function(a, b){ return d3.ascending(Math.abs(a[0]), Math.abs(b[0])) });
		
		dvc.flow0un = [];
		dvc.flow1un = [];
		flow2unsort = [];
		
		d3.selectAll(dvc.flow0).each(function(d,i){
			dvc.flow0un.push(dvc.flow0[i][0]);					
		});
		
		d3.selectAll(dvc.flow1).each(function(d,i){
			dvc.flow1un.push(dvc.flow1[i][0]);			
		});
		
		d3.selectAll(dvc.flow2).each(function(d,i){
			if (dvc.flow2[i][0]>=0){
				flow2unsort.push(dvc.flow2[i][0]);
			} else {
				flow2unsort.push(dvc.flow2[i][0]*-1);
			}
		});
		
		dvc.flow2un = flow2unsort.sort(function(a, b){ return d3.descending(Math.abs(a), Math.abs(b)); });
		
		dvc.coordsfrom = d3.select("#" + dvc.areacode).attr("data-cd");
		
		dvc.totals = dvc.flowdata.ons.totals[dvc.position];
		dvc.totalsin = dvc.totals[0];
		dvc.totalsout = dvc.totals[1];
		dvc.totalsnet = dvc.totals[2];
		
		dvc.totalsuse = dvc.flowdata.ons.totalsuse[dvc.position];
		dvc.totalswork = dvc.flowdata.ons.totalswork[dvc.position];
		
		makeTimeChart(dvc.totalsuse,dvc.totalswork);
		
		d3.select("#arealab").html(dvc.areaname);
		d3.select("#subarealab").html("total");
		
		definearray();
	    
	
		}
		
		else if (dvc.fix==true && dvc.ddselect==false) {
		
			d3.select("#int" + dvc.areacode).attr("class","intBarActive");
			
			dvc.arc = d3.select("#arc" + dvc.areacode);
			
			if(dvc.arc.empty() == false) {
			
			dvc.currclass = dvc.arc.attr("class");
			dvc.arc.attr("class", dvc.currclass + " mapArcsSel");
			
			}
				  
			d3.select("#arealab").html(dvc.fixareaname);
			d3.select("#subarealab").html("migration w/ " + dvc.areaname + "</span>");
	
			//makeTimeChart(dvc.flow0time[dvc.position],dvc.flow1time[dvc.position],dvc.flow2time[dvc.position]);
			updateleft([null, dvc.flow0time[dvc.position],dvc.flow1time[dvc.position],dvc.flow2time[dvc.position]]);

			
		}
		
	};

	
	function definearray () {
		
		arraynm=eval("dvc." + dvc.flow);
		dvc.jmtothemax = calculateMyIndexYieldingMaxPearsons(eval("dvc." + dvc.flow + "un"));
		spider(arraynm);
		
	}

	function spider(arraynm){
		
		
		if(dvc.storyover=true)	{
			makeChart(arraynm);		
		}
	
	if(dvc.flow =="flow2"){
		
		arraynm2 = dvc.flownet;
	
	} else {
		
		arraynm2 = arraynm.slice();
		arraynm2.reverse();
	}
	
	arcs = dvc.svg.append("g").attr("id", "mapArcs");
	arcsLow = arcs.append("g").attr("id","mapArcsLow");
	arcsHigh = arcs.append("g").attr("id","mapArcsHigh");
	
	lines = [];
	
	for(i=0; i<=arraynm2.length-1; i++) {
		lines.push({
			type: "LineString",
			coordinates: JSON.parse("[" + arraynm2[i][2] + "," + dvc.coordsfrom + "]")
		});
	}
	
	var arrlength = arraynm2.length;
	
	if(dvc.flow =="flow2"){
		
	arcs.selectAll(".mapArcsLow")
		.data(lines)
		.enter()
		.append("path")
		.attr("id",function(d,i) {return "arc" + arraynm2[i][1]}) 
		.attr("class",function(d,i) 
		{if(arraynm2[i][0] >= dvc.jmtothemax || arraynm2[i][0] <= (dvc.jmtothemax*-1))
			{if(arraynm2[i][0] >= 0) 
				{return "mapArcsHighP"}
			else 
				{return "mapArcsHighN"}
			}
			else {if(arraynm2[i][0] >= 0) 
					{return "mapArcsLowP"}
				else 
					{return "mapArcsLowN"}
			}
			 }) 
		.attr("d",dvc.path)
		.attr("pointer-events", "none");
	
	} else {
				
	arcs.selectAll(".mapArcsLow")
		.data(lines)
		.enter()
		.append("path")
		.attr("id",function(d,i) {return "arc" + arraynm2[i][1]}) 
		.attr("class",function(d,i) 
		{if(arraynm2[i][0] >= dvc.jmtothemax || arraynm2[i][0] <= (dvc.jmtothemax*-1))
			{return "mapArcsHigh"}
			else {return "mapArcsLow"} }) 
		.attr("d",dvc.path)
		.attr("pointer-events", "none");
	
	}

	animatepath();	
		
	}
	
	function animatepath () {
						
					d3.selectAll(".mapArcsHigh, .mapArcsHighP").transition()
							.duration(500000)
							.ease("linear")
							.attr("stroke-dashoffset", function(){if(dvc.flow=="flow0" || dvc.flow =="flow2")
									{return -2500}
									else
									{return 2500}			
							});
							//.each("end", animatepath);
							
					d3.selectAll(".mapArcsHighN").transition()
							.duration(500000)
							.ease("linear")
							.attr("stroke-dashoffset", 2500 );
							//.each("end", animatepath);
	}
	
	
	
	function removeSpider() {
		
			if (dvc.fix==false) {	
			
				arcs.remove();
				d3.select("#arealab").html("");
				d3.select("#subarealab").html("");
				bar.attr("y",0).attr("height",0);
				barint.attr("pointer-events","none");
				updateleft([null,0,0,0]);
				updateTimeChart([0,0,0],[0,0,0]);
				
			}
			
			else if (dvc.fix==true) {
				d3.select("#int" + dvc.areacode).attr("class","intBar");
				
				if(typeof dvc.arc != "undefined"){
				dvc.arc.attr("class",dvc.currclass);
				}
				revertsel(dvc.fixareacode);
			}
	}
	
	function revertsel (d) {
		
		dvc.areacode=d;
		
		dvc.position = dvc.flowdata.ons.area.indexOf(dvc.areacode);
		dvc.areaname = dvc.flowdata.ons.areaname[dvc.position];
		
		dvc.totals = dvc.flowdata.ons.totals[dvc.position];
		
		dvc.totalsin = dvc.totals[0];
		dvc.totalsout = dvc.totals[1];
		dvc.totalsnet = dvc.totals[2];
		
		makeTimeChart(dvc.totalsuse,dvc.totalswork);
		d3.select("#arealab").html(dvc.fixareaname);
		d3.select("#subarealab").html("total");
		// + "<br><span>total</span>");
	}
	
	function removeSpiderFix() {
		
				arcs.remove();
				
	}
	
	function fixSpider(area) {
		
			if(dvc.fix == true){
			dvc.fix=false;
			removeSpider();
			sel(area);
			}
			dvc.fix = true;

			dvc.fixareacode=area;

			var position = dvc.flowdata.ons.area.indexOf(area);
			dvc.fixareaname = dvc.flowdata.ons.areaname[position];
			
		
		$('#areaselect').val(area);
        $('#areaselect').trigger("chosen:updated");
			
		var subsel = d3.select("#subselection");
		
		if(subsel.empty() == false) {
			subsel.remove();
			
		}
		
		subareaopt();				
		updateHash();
			
	
		
	}
	
	
	function clearFix(){
		dvc.fix=false;
		removeSpider()
	}

	

function calculateMyIndexYieldingMaxPearsons(myInputArray)

{

	dvc.myInputDivisor			= myInputArray.length;
	var myInputSum 				= calculateMyArraySum(myInputArray);
	var myInputMean				= myInputSum/dvc.myInputDivisor;
	var myYIMinusYBarArray 			= calculateMyElementMinusMyMeanArray(myInputArray,myInputMean);
	var myYIMinusYBarSquaredArray 		= multiplyTwoArrays(myYIMinusYBarArray,myYIMinusYBarArray);
	var mySigmaYIMinusYBarSquared		= calculateMyArraySum(myYIMinusYBarSquaredArray);
	var mySqrtSigmaYIMinusYBarSquared 	= Math.sqrt(mySigmaYIMinusYBarSquared);
	var myPearsonsRSquaredMax=-10000000000000;
	var myJMax=0;

	for (j=0;j<myInputArray.length;j++)
	{ 
		var myCycleArray 			= calculateMyCycleArray(myInputSum,j,myInputArray.length);
		var myCycleDivisor			= myCycleArray.length;
		var myCycleSum 				= calculateMyArraySum(myCycleArray);	
		var myCycleMean				= myCycleSum/myCycleDivisor;
		var myXIMinusXBarArray 			= calculateMyElementMinusMyMeanArray(myCycleArray,myCycleMean);
		var myXIMinusXBarSquaredArray 		= multiplyTwoArrays(myXIMinusXBarArray,myXIMinusXBarArray);
		var mySigmaXIMinusXBarSquared		= calculateMyArraySum(myXIMinusXBarSquaredArray);
		var mySqrtSigmaXIMinusXBarSquared 	= Math.sqrt(mySigmaXIMinusXBarSquared);
		var myPearsonsRDivisor 			= mySqrtSigmaXIMinusXBarSquared * mySqrtSigmaYIMinusYBarSquared;
		var myXIMinusXBarTimesYIMinusYBarArray 	= multiplyTwoArrays(myXIMinusXBarArray,myYIMinusYBarArray);
		var mySigmaXIMinusXBarTimesYIMinusYBar	= calculateMyArraySum(myXIMinusXBarTimesYIMinusYBarArray);
		var myPearsonsR				= mySigmaXIMinusXBarTimesYIMinusYBar/myPearsonsRDivisor;
		var myPearsonsRSquared			= myPearsonsR*myPearsonsR

		if (myPearsonsRSquared>=myPearsonsRSquaredMax) {myPearsonsRSquaredMax=myPearsonsRSquared;myJMax=myInputArray[j];}
	}
	return(myJMax);
}



function calculateMyArraySum(myInputArray)
{
	m=1000000;
	myArraySum = 0;
	for (i=0;i<myInputArray.length;i++)
	{ 
	myArraySum = ((myArraySum*m) + (myInputArray[i]*m))/m;
	}
	return(myArraySum);
}	





function calculateMyElementMinusMyMeanArray(myInputArray,myInputMean)
{
		m=1000000;
		var myOutputArray = new Array();
		for (k=0;k<myInputArray.length;k++)
		{
			myOutputArray[k]=((myInputArray[k]*m)-(myInputMean*m))/m;
		}
		return(myOutputArray);
}



function multiplyTwoArrays(myInputArrayOne,myInputArrayTwo)
{
		m=1000000;
		var myOutputArray = new Array();
		for (k=0;k<myInputArrayOne.length;k++)
		{
			myOutputArray[k]=((myInputArrayOne[k]*m)*(myInputArrayTwo[k]*m))/(m*m);
		}
		return(myOutputArray);
}



function zipMultiplyMyArray(myInputArray,myInputNumber)
{
		m=1000000;
		var myOutputArray = new Array();
		for (k=0;k<myInputArray.length;k++)
		{
			myOutputArray[k]=((myInputArray[k]*m)*(myInputNumber*m))/(m*m);
		}
		return(myOutputArray);
}



function calculateMyCycleArray(myInputSum,j,myInputLength)
{
		m=1000000;
		var myCycleArray = new Array();
		for (k=0;k<j+1;k++)
		{
			myCycleArray[k]=(myInputSum*m)/((j+1)*m);
		}
		for (k=j+1;k<myInputLength;k++)
		{
			myCycleArray[k]=0;
		}
		return(myCycleArray);
}

		function makeChart(arraynm)
		{
			dvc.index=d3.range(dvc.myInputDivisor);//the number of records as a d3.range object
			
			dvc.minValue = arraynm[dvc.myInputDivisor-1][0];//already sorted so you don't want to resort again
	
			dvc.maxValue = arraynm[0][0];

			dvc.yScale=d3.scale.linear()
				.domain([Math.min(0,dvc.minValue),dvc.maxValue])
				.range([dvc.chartHeight,0])
				.nice();
				
			dvc.xScale = d3.scale.ordinal()
				.domain(arraynm.slice(1))
				.rangeRoundBands([0, dvc.chartWidth], dvc.gapRatio);
				
			dvc.cellWidth=(1-dvc.gapRatio)*dvc.chartWidth/dvc.myInputDivisor;
			
			mainChart = d3.select("#chart").selectAll('svg').data([arraynm]);
			
    	    mainChartEnter = mainChart.enter()
                              .append('svg')
							  .attr('id','mainChart')
							  .attr("viewBox", "0 0 340 210");
				
			mainChartEnter.append('text')
				  .attr("class","yLabel")
				  .text(dvc.yaxisSize)
				  .attr("text-anchor", "start")
				  .attr("transform", "translate(10,"+(dvc.yPadding-10)+")");		
			
			mainChartEnter.append("g")
				.attr("id","grpBars")
				.attr("transform", "translate(" + dvc.xPadding + "," + dvc.yPadding + ")");
			
			dvc.format = d3.format(".2s");

			dvc.yAxisChar=d3.svg.axis()
					.scale(dvc.yScale)
					.orient("left")
					.ticks(8);
					
			mainChartEnter.append("g")
				.attr("class","axis")
				.attr("transform","translate("+ dvc.xPadding + ", " + dvc.yPadding + ")")
				.call(dvc.yAxisChar);
				
			dvc.yGrid=d3.svg.axis()
					.scale(dvc.yScale)
					.orient("left")
					.ticks(8)
					.tickSize(-(dvc.chartWidth));
					
			mainChartEnter.append("g")
				.attr("class","grid")
				.attr("transform","translate(" + dvc.xPadding + "," + dvc.yPadding + ")")
				.call(dvc.yGrid);
			
			mainChartEnter.selectAll(".domain").style("stroke","none");
				
			bar = mainChart.select("#grpBars").selectAll(".chartBarsHighP, .chartBarsHighN, .chartBarsLowP, .chartBarsLowN, .chartBarsHigh, .chartBars")
				.data(arraynm);
			
			bar.enter()
					.append("rect")
					.attr("class", function(d,i) {
				if(d[0] >= dvc.jmtothemax || d[0] <= (dvc.jmtothemax*-1)) 
					{if(d[0] >= 0 && dvc.flow=="flow2") 
						{return "chartBarsHighP"} 
					else if(d[0] <= 0 && dvc.flow=="flow2") 
						{return "chartBarsHighN"} 
					else {return "chartBarsHigh"}
					}
				else {if(d[0] >= 0 && dvc.flow=="flow2")
						{return "chartBarsLowP"}
					
					else if(d[0] <= 0 && dvc.flow=="flow2") 
						{return "chartBarsLowN"} 
					else {return "chartBars"}	
					}

					})
					.attr("id",function(d, i) { 
						return "bar" + d[1];
					})
					.attr("width", dvc.cellWidth)
					.attr("y", function(d) { 
						return dvc.yScale(Math.max(0, d[0]));
					})
					.attr("height", function(d)	{
						return Math.abs(dvc.yScale(d[0]) - dvc.yScale(0));
					});
	
						
			bar.attr("width", dvc.cellWidth)
					.attr("id",function(d, i) { 
						return "bar" + d[1];
					})
					.attr("class", function(d,i) {
				if(d[0] >= dvc.jmtothemax || d[0] <= (dvc.jmtothemax*-1)) 
					{if(d[0] >= 0 && dvc.flow=="flow2") 
						{return "chartBarsHighP"} 
					else if(d[0] <= 0 && dvc.flow=="flow2") 
						{return "chartBarsHighN"} 
					else {return "chartBarsHigh"}
					}
				else {if(d[0] >= 0 && dvc.flow=="flow2")
						{return "chartBarsLowP"}
					
					else if(d[0] <= 0 && dvc.flow=="flow2") 
						{return "chartBarsLowN"} 
					else {return "chartBars"}	
					}
					})
					.attr("y", function(d) { 
						return dvc.yScale(Math.max(0, d[0]));
					})
					.attr("height", function(d)	{
						return Math.abs(dvc.yScale(d[0]) - dvc.yScale(0));
					});
					
			bar.exit().remove();
						
			bar.attr("transform", function(d, i) {
						return "translate(" + dvc.cellWidth* i +"," + 0  + ")";
					});



			barint = mainChart.select("#grpBars").selectAll(".intBar")
				.data(arraynm);
			
			barint.enter()
					.append("rect")
					.attr("class","intBar")
					.attr("id",function(d, i) { 
						return "int" + d[1];
					})
					.attr("width", dvc.cellWidth)
					.attr("y", function(d) { 
						return dvc.yScale(Math.max(0, d[0]));
					})
					.attr("height",dvc.chartHeight)
					.on("mouseover",function(d)	{
						highmatch(this);
					})
					.on("mouseout",function(d)	{
						d3.select(this).attr("class","intBar")
						unhighmatch(this);
						revertsel(dvc.fixareacode);
					});
	
						
			barint.attr("width", dvc.cellWidth)
					.attr("id",function(d, i) { 
						return "int" + d[1];
					})
					.attr("class","intBar")
					.attr("y",0)
					.attr("width",dvc.cellWidth);
					
			barint.exit().remove();
						
			barint.attr("transform", function(d, i) {
						return "translate(" + dvc.cellWidth* i +"," + 0  + ")";
					})
					.attr("pointer-events","all");;
		
			
				mainChart.select('.axis')
       			  	.transition()
  		          	.duration(500)
				  	.call(dvc.yAxisChar);
					
				mainChart.select('.grid')
				    .transition()
					.duration(500)
					.call(dvc.yGrid);

			dvc.xScale.domain(dvc.index);
			bar.attr("transform", function(d, i) {
						return "translate(" + dvc.cellWidth* i +"," + 0  + ")";
					})

			d3.selectAll(".chartBarSel").attr("class", "chartBars");
			d3.select("#bar" + dvc.first).attr("class", "chartBarSel");	
				
		}

		function makeTimeChart(totalsuse,totalswork) 
                { 
                        
                        if(dvc.firsttime == true) { 
                                dvc.firsttime = false; 
                        
					var w = 270,
						h = 300
			
						// create canvas
						var stacks = d3.select("#rightp").append("svg")
     					.attr("viewBox", "0 0 300 270")
						.attr("id", "mainStackChart")
						.append("g")
						.attr("transform", "translate(0,75) rotate(90)");
						
						x = d3.scale.ordinal().rangeRoundBands([0, w])
						y = d3.scale.linear().range([0, h])
							
						var yAxis3 = d3.svg.axis()
								.scale(y)
								.ticks(5)
								.orient("left");		
						
						
						var matrix = eval("[[" + totalsuse + "],[" + totalswork + "]]");
						
						var remapped =["c1","c2","c3","c4","c5","c6"].map(function(dat,i){
							return matrix.map(function(d,ii){
								return {x: ii, y: d[i] };
							})
						});
						console.log(remapped);
						var stacked = d3.layout.stack()(remapped);
						
						var usesum = d3.sum(totalsuse);	
						var worksum = d3.sum(totalswork);
													
						x.domain(stacked[0].map(function(d) { return d.x; }));
						y.domain([0, Math.max(d3.sum(totalsuse),d3.sum(totalswork))]);
			
						// Add a group for each column.
						dvc.valgroup = stacks.selectAll("g.valgroup")
						.data(stacked)
						.enter()
						.append("g")
						.attr("class", "valgroup")
						.attr("data-ty", function(d, i) {return dvc.flowdata.ons.dataTypeWork[i];})
						.style("fill", function(d, i) { return dvc.flowdata.ons.dataTypeColour[i]; })
						
						
						stacks.selectAll("text")
							.data(dvc.flowdata.ons.dataPop)
							.enter()
							.append("text")
							.text(function(d,i){return d})
							.attr("y",function(d,i){return 15 + (i * 60)})
							.attr("fill","#666")
							.attr("font-family","open_sansregular")
							.attr("transform","rotate(-90)");
							
						dvc.nformat = d3.format("0,000");	
								
						// Add a rect for each instance.
						dvc.rects = dvc.valgroup.selectAll("rect")
						.data(function(d){return d;})
						.enter().append("rect")
						.attr("class","stackrect")
						.attr("x", function(d,i) {return 20 + i*60 })
						.attr("y", function(d) { return -y(d.y0) - y(d.y); })
						.attr("height", function(d) { return y(d.y); })
						.attr("width", 30)
						.attr("data-nm", function(d,i) {if(i==0){return d3.select(this.parentNode).attr("data-ty") + ":<br>" +  dvc.nformat(d.y) + "<br>(" + Math.round((d.y/usesum)*100) + "%)"}
								else {return d3.select(this.parentNode).attr("data-ty") + ":<br>" +  dvc.nformat(d.y) + "<br>(" + Math.round((d.y/worksum)*100) + "%)"}});
					  
					  
					  	d3.select("#mainStackChart").select("g").append('g')
							.attr('class','axis')
							.attr("transform", "translate(110,0) rotate(180)")
							.call(yAxis3)
						.selectAll("text")
							.attr("y",15)
							.attr("x",0)
							.attr("transform","rotate(90)")
							.style("text-anchor","middle");
  						
  
         
                                 
                        var legend = stacks.append('g').attr("id","legend")
													   .attr("transform","translate(200,65) rotate(-90)")
													   .selectAll('g.legend') 
                                                       .data(dvc.flowdata.ons.dataTypeUse) 
                                                       .enter() 
                                                  .append('g') 
                                                        .attr('class', 'legend'); 
                                        
                                                legend.append('rect') 
                                                        .attr('x', function(d, i){if(i <= 2) {return 70} else {return 230}}) 
                                                        .attr('y', function(d, i){if(i <= 2) {return (i*17)-60} else {return ((i-3)*17)-60}})
                                                        .attr('width', 10) 
                                                        .attr('height',10) 
                                                        .style('fill', function(d,i) { return dvc.flowdata.ons.dataTypeColour[i]});
                                        				
														
                                                legend.append('text') 
                                                        .attr('x', function(d, i){if(i <= 2) {return 85} else {return 245}}) 
                                                        .attr('y', function(d, i){if(i <= 2) {return (i*17)-51} else {return ((i-3)*17)-51}}) 
                                                        .text(function(d, i){return d; }); 
														
														
                   		var tip = d3.tip()
						  .attr('class', 'd3-tip')
						  .offset([-13, 0])
						  .direction('n')
						  .html(function(d) {
							return d3.select(this).attr("data-nm");
						  });
						  
						d3.selectAll('.stackrect').call(tip);
						
						d3.selectAll(".stackrect")
							.attr("pointer-events","all")
							.on("mouseover", tip.show)
							.on("mouseout", tip.hide); 
							
					
							
						var leftText = [dvc.units, dvc.totalsin[dvc.timeIndex],dvc.totalsout[dvc.timeIndex], dvc.totalsnet[dvc.timeIndex]]; 
										
						updateleft(leftText);
		
 
 
                        } 
                        
                        else { 
                                updateTimeChart(totalsuse,totalswork);
								var leftText = [dvc.units, dvc.totalsin[dvc.timeIndex],dvc.totalsout[dvc.timeIndex], dvc.totalsnet[dvc.timeIndex]]; 
										
								updateleft(leftText);
                        } 
                                                
                }//end of makeTimeChart 

                function updateTimeChart (totalsuse,totalswork) { 
				
				
						var matrix = eval("[[" + totalsuse + "],[" + totalswork + "]]");
				
						var remapped =["c1","c2","c3","c4","c5","c6"].map(function(dat,i){
							return matrix.map(function(d,ii){
								return {x: ii, y: d[i] };
							})
						});

						var usesum = d3.sum(totalsuse);	
						var worksum = d3.sum(totalswork);

						var stacked = d3.layout.stack()(remapped)
									
						x.domain(stacked[0].map(function(d) { return d.x; }));
						y.domain([0, Math.max(d3.sum(totalsuse),d3.sum(totalswork))]);
				
						var yAxis3 = d3.svg.axis()
							.scale(y)
							.ticks(5)
							.orient("left");	
						
						dvc.valgroup = dvc.valgroup.data(stacked);
						
						dvc.rects = dvc.rects.data(function(d){return d;});
						
						dvc.rects.transition().duration(500).attr("y", function(d) { return -y(d.y0) - y(d.y); })
							.attr("height", function(d) { return y(d.y); })
							.attr("data-nm", function(d,i) {if(i==0){return d3.select(this.parentNode).attr("data-ty") + ":<br>" +  dvc.nformat(d.y) + "<br>(" + Math.round((d.y/usesum)*100) + "%)"}
										else {return d3.select(this.parentNode).attr("data-ty") + ":<br>" +  dvc.nformat(d.y) + "<br>(" + Math.round((d.y/worksum)*100) + "%)"}});
						
						d3.select("#mainStackChart").select(".axis").call(yAxis3)
							.selectAll("text")
							.attr("y",15)
							.attr("x",0)
							.attr("transform","rotate(90)")
							.style("text-anchor","middle")
							.transition().duration(500);

                        
                } 
				
		function arcTween(a) {
			var i = d3.interpolate(this._current, a);
			this._current = i(0);
			return function(t) {
				return arc(i(t));
			};
		}
		
		function arcTween2(a) {
			var i = d3.interpolate(this._current2, a);
			this._current2 = i(0);
			return function(t) {
				return arc(i(t));
			};
		}




		function highmatch(curr) {
				
				dvc.currentbar = d3.select(curr).attr("id").substring(3,13);	
				highlightarc();
				
		}
		
		function highlightarc () {
				dvc.curr = d3.select("#" + dvc.currentbar);
				dvc.curr.attr("class","polyhigh");
				dvc.arc = d3.select("#arc" + dvc.currentbar);
				dvc.currclass = dvc.arc.attr("class");
				dvc.arc.attr("class", dvc.currclass + " mapArcsSel");
		
				var position = dvc.flowdata.ons.area.indexOf(dvc.currentbar);
				dvc.areaname = dvc.flowdata.ons.areaname[position];
				d3.select("#arealab").html(dvc.fixareaname);
				d3.select("#subarealab").html("migration w/ " + dvc.areaname);
				updateleft([null,dvc.flow0time[position],dvc.flow1time[position],dvc.flow2time[position]]);
		}
		
		function unhighmatch() {
				dvc.curr.attr("class","mapPoly");
				dvc.arc.attr("class", dvc.currclass);
		}

		function updateleft (leftText) {
			
				dvc.nformat = d3.format("0,000");
					if(leftText[i+1]>=0) {
						d3.selectAll('.leftno').text(function(d,i){return dvc.nformat(leftText[i+1])});
						$('#leftfigprefix' + i).text("£");
					} else {
						d3.selectAll('.leftno').text(function(d,i){return dvc.nformat(leftText[i+1])})
						$('#leftfigprefix' + i).text("-");
					}
					
				d3.selectAll(".leftunit")
					.text(leftText[0]);

		}
	
/* Swiper controls */

  var mySwiper = new Swiper('.swiper-container',{
    pagination: '.pagination',
    loop: false,
    grabCursor: true,
    paginationClickable: true,
	hashNav: true
  });
	
  $('.arrow-left').on('click', function(e){
    if(dvc.swiping == false){
		
		e.preventDefault();
		mySwiper.swipeTo(mySwiper.activeIndex-1);
	}
	
  });
  $('.arrow-right').on('click', function(e){
	if(dvc.swiping == false){

		e.preventDefault();
		mySwiper.swipeTo(mySwiper.activeIndex+1);
	
	}
  });
  $('.close').on('click', closeStory);
/* End swiper controls */



	function requestFullScreen() {
			d3.select("#container").style("width","100%").style("height","100%");
			var element = document.getElementById("container");
			var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullScreen;
		
			if (requestMethod) { // Native full screen.
				requestMethod.call(element);
			} else if (typeof window.ActiveXObject !== "undefined") { // Older IE.
				var wscript = new ActiveXObject("WScript.Shell");
				if (wscript !== null) {
					wscript.SendKeys("{F11}");
				}
			}
		}
		
	
	
	
	
		  
 	/* Social stuff */
		
		function makeFace()
		{
			var face = 'http://www.facebook.com/share.php?u=' + window.location.href;
			window.open(face);
		}
		
		
		function post2Twitter()
		{
		if(dvc.fix){
			var myString="http://twitter.com/home?status="+escape("Where are people moving to and from in " + dvc.fixareaname + "? #migration "+ window.location.href +" via @ONS");
			window.open(myString);
		} else {
			var myString="http://twitter.com/home?status="+escape("Where are people moving to and from? #migration "+ window.location.href +" via @ONS");
			window.open(myString);
		}
		
		}

		function showEmbed()
		{
			$('#embedurl').val('<iframe width="940" height="710" src="' + document.URL + '"webkitAllowFullScreen mozAllowFullScreen allowFullScreen scrolling="no" frameborder="0"/>');
			$('#embedbox').show(400);
		}

		function embedHide()
		{
			$('#embedbox').hide(400);
		}

   			
		//Hash URL stuff
		function getParams() {

		  firstbit = window.location.href.split(".html")[0];

		  var url = decodeURI(window.location.hash);
		
		  if(url != "") {
			params = url.split("&");
			dvc.storyover = params[0].split("=")[1];
			dvc.preflow = params[1].split("=")[1];
			dvc.timeIndex =params[2].split("=")[1];
			dvc.preselect =params[3].split("=")[1];
			dvc.view =params[4].split("=")[1];
			
			dvc.newviewminx = parseFloat((dvc.view.split(","))[0]);
			dvc.newviewminy = parseFloat((dvc.view.split(","))[1]);
			dvc.newviewWidth = parseFloat((dvc.view.split(","))[2]);
			dvc.newviewHeight = parseFloat((dvc.view.split(","))[3]);
	
			dvc.trans = params[5].split("=")[1];
			dvc.scale =params[6].split("=")[1];
		  } else {		setTimeout(function(){changecont(1);
						mySwiper.swipeTo(0)},2000);
						}
		}
	
		function updateHash() {
			  window.location.hash = encodeURI("sty=" + dvc.storyover + "&flow=" + dvc.flow + "&period=" + dvc.timeIndex + "&fix=" + dvc.fixareacode + "&view=" + dvc.newviewminx + "," + dvc.newviewminy + "," + dvc.newviewWidth + "," +  dvc.newviewHeight + "&tr=" + dvc.trans  + "&sc=" + dvc.scale );
		}


} 	else  // from modernizer
	
	{
		$("#ieMsg").fadeIn(1000);
		
	}


		/*Analytics */
		
		/*Google*/
		
		  var _gaq = _gaq || [];
		  _gaq.push(['_setAccount', 'UA-37894017-1']);
		  _gaq.push(['_trackPageview']);
		
		
		  (function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();
	
		
		
		/*webtrends*/
		
		var _tag=new WebTrends();
		_tag.dcsGetId();
		//]]>
		</script>
		<script type="text/javascript">
		//<![CDATA[
		_tag.dcsCustom=function(){
		// Add custom parameters here.
		//_tag.DCSext.param_name=param_value;
		}
		_tag.dcsCollect();
		</script>
		<noscript>
		<div><img alt="DCSIMG" id="DCSIMG" width="1" height="1" src="//statse.webtrendslive.com/dcsay0hycvz5bd4kzkvzlhgdu_5j1u/njs.gif?dcsuri=/nojavascript&amp;WT.js=No&amp;WT.tv=9.4.0&amp;dcssip=www.statistics.gov.uk"/></div>
		</noscript>


						
        </script>	




</script>

</body>
</html>