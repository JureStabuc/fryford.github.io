<!--Hi, Welcome, Take off your shoes, make yourself at home, and enjoy the code-->
<!--I'm not the best code in the world but it does a job - @fryford - Data Visualisation Centre - Office for National Statistics -->
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="lib/idangerous.swiper.css">
	<!--<script src="lib/d3.v3.min.js"></script>-->
    <link rel="stylesheet" href="lib/jquery-ui-1.10.4.custom.min.css">
    <link rel="stylesheet" href="lib/style.css">
    
    <script src="lib/d3.v3.min.js" charset="utf-8"></script>
    <script src="lib/topojson.min.js"></script>
	<script src="lib/d3.geo.projection.v0.min.js"></script>
    <script src="lib/jquery-1.10.1.min.js"></script>
    <script src="lib/jquery-ui-1.10.4.custom.min.js"></script>
    <script src="lib/idangerous.swiper-2.1.min.js"></script>
    <script src="lib/idangerous.swiper.hashnav.js"></script>
    <script src="lib/countto.js"></script>
    <!--<script src="lib/selectric.min.js"></script>-->
    <script src="lib/chosen.jquery.js"></script>
    <script src="lib/d3.slider.js"></script>
    
    

<style>

html, body, div, span, applet, object, iframe,
h1, h2, h3, h4, h5, h6, p, blockquote, pre,
a, abbr, acronym, address, big, cite, code,
del, dfn, em, img, ins, kbd, q, s, samp,
small, strike, strong, sub, sup, tt, var,
b, u, i, center,
dl, dt, dd, ol, ul, li,
fieldset, form, label, legend,
table, caption, tbody, tfoot, thead, tr, th, td,
article, aside, canvas, details, embed, 
figure, figcaption, footer, header, hgroup, 
menu, nav, output, ruby, section, summary,
time, mark, audio, video
{
	margin: 0;
	padding: 0;
	border: 0;
	font-size: 100%;
	font: 'open_sansregular';
	vertical-align: baseline;
	
}

		html {
			height:100%;	
		}

		@font-face {
			font-family: 'open_sanslight';		
			src: url('./lib/OpenSans-Light-webfont.woff') format('woff');
			font-weight: normal;
			font-style: normal;
		
		}
		
		@font-face {
			font-family: 'open_sansregular';		
			src: url('./lib/OpenSans-Regular-webfont.woff') format('woff');
			font-weight: normal;
			font-style: normal;
		
		}
	
	
		
	   body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; 
        font-size: 14px;
		margin:0px auto;
		height:100%;

      }
	  
	  #container {
		height:100%;
		width:100%;	
		left:0;
		display:block;
			  
	  }
	  
	  #mapDiv {
		
/*		left:20px;
		top:50px;
		margin:0px auto;*/
		position:absolute;
		display:block;
		top:65px;
		left:0;
		background-color:#fff;
		width:100%;
		height: -webkit-calc(100% - 80px);
		height: -ms-calc(100% - 80px);
		height: -moz-calc(100% - 80px);
		height: calc(100% - 80px);
		
	
	  }
	  
	  #mapDiv svg {
		position:absolute;
		top:0px;
	  }
	  
	  #mapSVG {
		  
		width:100%;
		height: 100%;
	
	  }
	  
	  
	  #defs {
		
		height:0px;
		  
	  }
	
	  
	  path.mapPoly {
        stroke: #666;
        stroke-width: 0.05%;
		fill:#eee;
      }
	  
	  .polyhigh {
		stroke: #FFF;
		stroke-width: 1;
		fill:#666;
	  }
	  
      path.mapPoly:hover {
		fill:#666;
      }
	  
	  #mapGraticule	{
		fill:none;
		stroke:#C9C9C9;
		stroke-dasharray: 2,2;
		stroke-width:0.1%;  
	  }
	  
	 .mapArcs	{
	
	  }
	  
	 .mapArcsLow	{
		fill:none;
		/*stroke:#59A4DA;*/
		stroke-width:0.1%; 
		stroke-linecap:round; 
		opacity:0.5;
  
	  }
	  
	  .mapArcsHigh	{
		fill:none;
		opacity:1;
		stroke-width:0.3%;
		stroke-linecap:round;
		stroke-dasharray: 5,3;
		
	  }
	  
	  .mapArcsLow	{
		fill:none;
		/*stroke:#59A4DA;*/
		stroke-width:0.1%; 
		stroke-linecap:round; 
		opacity:0.5;
  
	  }
	  
	  .mapArcsSel	{
		  
		fill:none;
		opacity:1;
		stroke: red;
		stroke-width:0.3%;
		stroke-linecap:round;
		
	  }
	  
	  
	  #flowtype {
		position:absolute;
		/*display:none; */ 
		top:16px;
		right:-2px;
	  }
	  
	
/* Swiper content */
	  
.device {
  width: 340px;
  height: 100%;
  position: relative;
  background: rgba(250,250,250,0.7);
  /*padding: 30px 40px;*/
  /*box-shadow: 0px 0px 10px #666;*/
  z-index:+5;
}
.device .arrow-left {
  background: url(images/prev.png) no-repeat left top;
  display:inline-block;
  /*position: absolute;*/
  /*left: 10px;*/
  /*top: 50%;*/
  width: 67px;
  height: 65px;
  margin-left:20px;
  opacity:0.7;

}
.device .arrow-right {
  background: url(images/next.png) no-repeat left bottom;
  display:inline-block;
  /*position: absolute;
  left: 310px;
  top: 50%;*/  
  width: 67px;
  height: 65px;
  margin-left:20px;
  margin-right:100px;
  opacity:0.7;

  
}

.device .arrow-right:hover {
	opacity:1;
}

.device .arrow-left:hover {
	opacity:1;
}


.close {
  background: url(images/close.png) no-repeat left bottom;
  display:block;
  /*position: absolute;
  left: 310px;
  top: 50%;*/ 
  font-family: 'open_sansregular';
  line-height: 15px;
  width: 30px;
  height: 29px;
  margin-left:35px;
  padding-left: 38px;
  opacity:0.5;
  
}

.close:hover {
	opacity:1;
}

a.close {
	text-decoration: none;
}


.swiper-container {
  height: 600px;
  width: 340px;
  
  position:relative;
  left:0px;
}
.content-slide {
  width:300px;
  height: 450px;
  font-family: 'open_sansregular';
  padding: 20px;
  color: #666;
}
.title {
  font-size: 25px;
  margin-bottom: 10px;
}
.pagination {
  position: absolute;
  left: 0;
  text-align: center;
  bottom:5px;
  width: 30%;
}
.swiper-pagination-switch {
  display: inline-block;
  width: 10px;
  height: 0px;
  border-radius: 10px;
  background: #999;
  box-shadow: 0px 1px 2px #555 inset;
  margin: 0 3px;
  cursor: pointer;
}
.swiper-active-switch {
  background: #fff;
}

/*#curryear {
	width:200px;
	height:40px;
	font-family: 'open_sansregular';
	font-size:30px;
	fill:#0581c9;
	display:none;
	stroke:#FFF;
	stroke-width:0.3px;
}*/

#arealab {
	font-family: 'open_sansregular';
	font-size:26px;
	color:rgb(5,201,129);
	margin: 0px 0px 5px 5px;
	padding-right:20px;
	/*stroke:#FFF;
	stroke-width:0.3px;*/
}

#currtime {
	position:absolute;
	left:10px;
	top:3px;
	font-family: 'open_sansregular';
	font-size:36px;
	color:rgb(5,201,129);
	z-index:11;
	/*stroke:#FFF;
	stroke-width:0.3px;*/
}


#chartText {
	position:absolute;
	top:0px;
	left:211px;
	font-family: 'open_sansregular';
	font-size:18px;
	color:#fff;
	margin: 8px 0px 5px -13px;
	
}




/* CSS for chart */

#toppanel {
	
	width:100%;
	height:65px;
	position:absolute;
	left:0;
	top:0px;
	/*display:none;*/
	border-bottom: 2px #0581c9 solid; 
	background-color:#fff;
	z-index:10;
	/*pointer-events:none;*/
	
}

#titlepanel {
	position:absolute;
	top:14px;	
	font-family: 'open_sansregular';
	font-size:30px;
	padding-left:20px;
	color:#0581c9;
}



#panel {
	
	width: 350px;
	height:100%;
	position:absolute;
	bottom:0px;
	display:none;
	right:0px;
	background-color:rgba(255,255,255,0.9);
	/*box-shadow: 0px 0px 6px rgba(0,0,0,.2);*/
	z-index:8;
	/*pointer-events:none;*/
	
	position: absolute;
	/*margin-left: auto;
	margin-right: auto;
	left: 0;
	right: 0;*/
	
}

#leftp {
	
	width:209px;
	height:172px;
	position:absolute;
	left:5px;
	top:58px;
	/*background-color:rgba(5,201,129,0.7);*/
	border: rgb(5,201,129) 2px solid;
}


#lefttop {
	
	
	height:38px;
	position:absolute;
	left:5px;
	top:30px;
	z-index:10;
	background-color:rgba(255,255,255,0.95);
	
	
}

#middlep {
	
	width:330px;
	height:172px;
	position:absolute;
	left:5px;
	top:255px;
	/*background-color:rgba(50,50,50,0.4);*/
	border: rgb(201,5,175) 2px solid;
}



#middletop {
	
	width:90px;
	height:21px;
	position:absolute;
	left:5px;
	top:255px;
	background-color:rgba(201,5,175,0.5);
	color:#fff;
	padding:5px 0px 0px 0px;
	text-align:center;
	text-transform:lowercase;
}


#rightp {
	
	width:330px;
	height:172px;
	position:absolute;
	left:5px;
	top:450px;
	/*background-color:rgba(50,50,50,0.1);*/
	border: rgb(5,175,201) 2px solid;
	
}

#righttop {
	
	width:90px;
	height:21px;
	position:absolute;
	left:5px;
	top:450px;
	background-color:rgba(5,175,201,0.5);
	color:#fff;
	padding:5px 0px 0px 0px;
	text-align:center;
}


.leftLabels {

	position:absolute;
	color:rgb(5,201,129);
	font-family:'open_sansregular';
	font-size:20px;
	
}

.leftFigures {

	position:absolute;
	color:rgb(5,201,129);	
	font-family:'open_sansregular';
	font-size:20px;
	
}



#sliderTime {
	
	width:70%;
	height:50px;
	position:absolute;
	left:0px;
	top:2px;
	display:none;
	
	background-color:rgba(255,255,255,0.6);
	/*box-shadow: 0px 0px 6px rgba(0,0,0,.2);*/
	z-index:9;
	opacity:0.3;
	/*pointer-events:none;*/
	
}

#sliderTime:hover {
	opacity:1;
	z-index:10;
}

		#slider
		{
			position:absolute;
			display: block;
			left:150px;
			top:0px;
			/*background-color:#0581c9;*/
			
		}


		#foot {
			position:absolute;
			bottom:0px;
			left:0px;
			height:15px;
			width:100%;

				
		}
		
		#foot a {
			font-size:10px;
			float:right;
			margin-right:10px;
			color: #0581c9;
			font-family: 'open_sansregular';
			
			
		}
		
		a {
			text-decoration:none;
		}
		
		
		a:hover {
			text-decoration: underline;	
		}

	/******* Chart CSS **********/
		body
		{
			font-family:Arial, Helvetica, sans-serif;	
			position: relative;
   			width: 100%;
		}
		
		
		#mainChart
		{
			position:absolute;
			top:0px;
			left:250px;
			width:340px;
			height:210px;
			/*border-radius:5px;*/
			/*background:rgba(98,177,246,0.1);*/
			/*z-index:11;*/
		
		}
		
		#mainChart line, #mainChart path
		{
			stroke:#ccc;		
		}

		#mainChart text
		{
			fill:#999;		
		}

		
		button
		{
			margin: 10px 10px 0 10px;
		}
		

		
		#chartTitle
		{
			font-size:18px;
		}
		
		#chartSubtitle, #chartUnits
		{
			font-size:12px;
			fill:#666;
			
		}
		
		#dataSource, #footNote, .credit
		{
			font-size:10px;
		}
		
		#txtTime
		{
			font-size:28px;
			font-weight:bold;
			fill:#0581c9;

			font-family: 'robotothin';
			text-anchor:middle;
			
		}
		
		.yLabel {
			
			fill:#999;
			font-size:12px;
			/*font-weight:bold;*/
			height:20px;
			width:30px;
						
		}
		

		.barText {
			text-anchor:end;
			fill:#666;	
			font-family:Arial, Helvetica, sans-serif;	
			font-size:11px;
		}
		
		.barText2 {
			text-anchor:start;
			fill:#666;
			font-family:Arial, Helvetica, sans-serif;	
			font-weight:bold;
			font-size:11px;
		}
		
		.axis path,
		.axis line
		{
			fill: none;
			stroke: #ccc;
			stroke-width: 0.1%
		}
		
		.axis text
		{
			fill:#666;
			font-size:11px;
			font-family:Arial, Helvetica, sans-serif
		}
		
		.grid path,
		.grid line
		{
			fill: none;
			stroke: #cccccc;
			stroke-width: 0.1%
		}
		
		/*don't need to display the text on the secondary grid element*/
		.grid text
		{
			display:none;
		}
		
		.barMarker
		{
			fill:steelblue;
			fill-opacity:0.5;
		}
		
		.intBar
		{
			fill-opacity:0;
			
		}
		
       .intBar:hover
	   { 
            fill:#ccc; 
            fill-opacity:0.8;         
                        
        } 
		
		.intBarActive
		{
			fill:#ccc;
			fill-opacity:0.8;	
		}
		
		.chartBarSel
		{
			fill:red;	
		}
		
		.chartBarsHigh
		{
			fill:orange;	
		}
		
		
		.chartBars
		{
			fill:#0581c9;
		}
		
		.selText
		{
			fill:black;	
			text-anchor:end;
		}
		
		
		
		
	/*Time Chart CSS */

		
		#mainTimeChart
		{
			position:absolute;
			top:-5px;
			left:605px;
			width:313px;
			height:210px;
			/*border-radius:5px;*/
			/*background:rgba(98,177,246,0.1);*/
			/*z-index:11;*/
		
		}
		
		
		.tick .major {
			stroke-width: 0.1%;
			stroke: #CCC;
			fill:none;
			
				
		}
		
		.legend {
		
			font-size:11px;
			fill:#666;
		}
		
		
		#controls {
		position:absolute;
		top:15px;
		right:0px;
		width:300px;
		display:none;
		
		}

#sel {
 width:280px;	
}

/*****************************************/
/* D3 Slider							 */
/*****************************************/

.d3-slider {
    position: relative;
    font-family: 'open_sansregular';
    font-size: 1.1em;
	background-color: #0581C9;
    z-index: 2;
	
}


.d3-slider-horizontal {
    height: 8px;
	width:450px;
}  

.d3-slider-range {
  background:#2980b9;
  left:0px;
  right:0px;
  height: 0.8em;
  position: absolute;
}

.d3-slider-range-vertical {
  background:#2980b9;
  left:0px;
  right:0px;
  position: absolute;
  top:0;
}

.d3-slider-vertical {
    width: .8em;
    height: 100px;
}      

.d3-slider-handle {
    position: absolute;
    width: 15px;
    height: 15px;
	border: 1px solid #0581C9;
    border-radius: 11px;
    background: #fff;
    z-index: 3;
}

.d3-slider-handle:hover {
    border: 1px solid #FFBF00;
}

.d3-slider-horizontal .d3-slider-handle {
    top: -5px;
    margin-left: -8px;
}

.d3-slider-axis {
    position: relative;
    z-index: 1;    
}

.d3-slider-axis-bottom {
    top: .8em;
}

.d3-slider-axis-right {
    left: .8em;
}

.d3-slider-axis path {
    stroke-width: 0;
    fill: none;
}

.d3-slider-axis line {
    fill: none;
    stroke: #0581C9;
    shape-rendering: crispEdges;
}

.d3-slider-axis text {
    font-size: 11px;
	fill:#0581C9;
}

.d3-slider-vertical .d3-slider-handle {
    left: -.25em;
    margin-left: 0;
    margin-bottom: 0em;      
}

/* Social */		
#fullscreen {
	position:absolute;
	top:10px;
	right:50px;
	height:30px;
	width:50px;
	background-color:#FF1FAA;	
	z-index:40;
}


#headingbar {

			

			float:left;
			height: 30px;
			width: 100%;
			margin: 0px auto;
			background:#fff;

			z-index:+1;	
			/*box-shadow: 2px 2px 3px rgba(0,0,0,.2);*/
			 
		}
		
	
		#twitter {
			display:block;
			margin:2px 5px 5px 2px;
			width:25px;
			height:25px;
			float:right;
			background-position: right;
			background:transparent url('./images/twitblue.png') center top no-repeat;
		
		}
		
		#twitter:hover {
			
			float:right;
			background:transparent url('./images/twitorange.png') center top no-repeat;
		}

		#face {
			display:block;
			margin:2px 5px 5px 2px;
			width:25px;
			height:25px;
			float:right;
			background-position: right;
			background:transparent url('./images/faceblue.png') center top no-repeat;
		
		}
		
		#face:hover {
			
			float:right;
			background:transparent url('./images/faceorange.png') center top no-repeat;
		
		}
		
		
		#full {
			display:block;
			margin:5px 12px 5px 2px;
			width:20px;
			height:20px;
			float:right;
			background-position: right;
			background:transparent url('./images/fullblue.png') center top no-repeat;
		
		}
		
		#full:hover {
			
			float:right;
			background:transparent url('./images/fullorange.png') center top no-repeat;
		
		}
		
		#embed {
			display:block;
			margin:2px 5px 5px 2px;
			width:25px;
			height:25px;
			float:right;
			background-position: right;
			background:transparent url('./images/embedblue.png') center top no-repeat;
		
		}
		
		#embed:hover {
			
			float:right;
			background:transparent url('./images/embedorange.png') center top no-repeat;
		
		}


		#embedbox{

			position:absolute;
			right:0px;
			top:0px;
			height:35px;
			width:300px;
			display:none;
			background:rgba(98,177,246,0.8);
			z-index:10;
			padding:15px;

		}

		

		#embedbox p {
			
			font-size:12px;
			color:#fff;
	
		}
		
		#embedurl {
			width:285px;
			color:#666;
		}
		
		#close {
			display:block;
			margin:-5px -5px 5px 5px;
			width:14px;
			height:14px;
			float:right;
			background-position: right;
			background:transparent url('./images/closewhite.png') center top no-repeat;

		}


	  
</style>


<title>d3 flow mapping template</title>

</head>

<body>

<div id="container">

<div id="toppanel">
    <div id="headingbar">

        <a href='javascript:post2Twitter()' id="twitter" title="share me on twitter"></a>
        <a href='javascript:makeFace()' id="face" title="share me on facebook"></a>
        <a href='javascript:showEmbed()' id="embed" title="please embed me!"></a>
        <a href='javascript:requestFullScreen()' id="full" title="go fullscreen"></a>
         
    </div>

    <div id="embedbox" display='none'>
    		<a href='javascript:embedHide()' id="close" title="close box"></a>
            <p>Paste HTML to embed in website</p>
			<input type='text' id='embedurl' name='iframe'/>
    </div>



</div>
<div id="mapDiv">
	
 	<div id="panel">
    	<div id="leftp"></div>
        <div id="lefttop"></div>
    	<div id="middlep"></div>
        <div id="middletop">in</div>
    	<div id="rightp"></div>
        <div id="righttop">time-series</div>
    </div>
    
 

  <div class="device">
    
    <div class="swiper-container">
      <div class="swiper-wrapper">
        <div class="swiper-slide" data-hash="slide1">
          <div class="content-slide">
            <p class="title">Look at this trade data</p>
            <p>The UK's biggest trade partner is the US of A.<br><br>We can put all sorts of information in here, text, charts, pictures of cute cats from t'internet - you name it, we can put it in.<br><br>Shankle chuck capicola, pork chop brisket strip steak cow drumstick rump kevin leberkas turkey ribeye short loin. Shoulder ground round brisket, andouille landjaeger pork tri-tip prosciutto ribeye pork loin doner. Pork ribeye doner tongue jerky boudin chuck flank, drumstick andouille hamburger. Short ribs flank andouille, pancetta rump ground round beef ribs. Fatback sausage turkey, prosciutto shoulder meatloaf pancetta salami flank pork belly. Shoulder t-bone bacon swine pork belly.</p>
          </div>
            <a class="arrow-left" href="#"></a> 
			<a class="arrow-right" href="#"></a>
            <div class="pagination"></div>
            <a class="close" href="#">
            Skip introduction
            </a>
        </div>
        <div class="swiper-slide" data-hash="slide2">
          <div class="content-slide">
            <p class="title">Other big partners</p>
            <p>Are Australia, India and China</p>
            <img height="270px" src="images/cutecat.jpg"></img>
          </div>
            <a class="arrow-left" href="#"></a> 
			<a class="arrow-right" href="#"></a>
            <div class="pagination"></div>
            <a class="close" href="#">
            Skip introduction
            </a>
         </div>
        <div class="swiper-slide"data-hash="slide3">
          <div class="content-slide">
            <p class="title">Title</p>
            <p>Some more nonsense</p>
          </div>
            <a class="arrow-left" href="#"></a> 
			<a class="arrow-right" href="#"></a>            <div class="pagination"></div>
            <a class="close" href="#">
            Skip introduction
            </a>
        </div>
      </div>
    </div>
  </div>
  

  


	<div id="sliderTime">
    
    </div>
  
  
  
</div>

<div id="foot">
<a href="http://bit.ly/onsdatavis" target="_blank">See more by the ONS Data Visualisation Centre</a>
</div>
</div>

    






<script>


var dvc = {};


	dvc.width = 940,
    dvc.height = 635,
	dvc.clipMode = false,
	dvc.flow = 'flow0'
	dvc.fix = false;
	dvc.xPadding=35;
	dvc.yPadding=65;
	
	dvc.chartWidth = 260,
	dvc.chartHeight = 130,
	dvc.gapRatio = 0,
	dvc.timeIndex = 1;
	dvc.selection = false;
	
	dvc.storyover=false;
	dvc.firsttime=true; 
	dvc.ddselect=false;
	dvc.preselect = "UK";
		
	/*var projection = d3.geo.airy()
 .rotate([50, -40])
    .scale(340)
    .translate([width / 2, height / 2])
    .precision(.1)
    .clipAngle(90)
    .radius(90);*/
	
	dvc.projectionFlat = d3.geo.mercator()
		.scale(20500)
		.translate([620,3850])
		.precision(1);

	dvc.projectionGlobe = d3.geo.orthographic()
	.rotate([2.3,-53.3])
    .scale(5600)
    .clipAngle(90)
    .precision(.1);

	dvc.projection = dvc.projectionFlat;

	dvc.path = d3.geo.path()
	.projection(dvc.projection);

	dvc.svg = d3.select("#mapDiv").append("svg")
	.attr("id","mapSVG")
    //.attr("width", dvc.width)
    //.attr("height", dvc.height)
	.attr("viewBox", "0 -40 " + 650 + "  "+ dvc.height);

	  
	dvc.svg.append("g").attr("id","mapGraticule");
	
	dvc.svg.append("g").attr("id","mapPolygons");
	
	dvc.graticule = d3.geo.graticule()
                    .step([10, 10]);

	dvc.axes = dvc.svg.append("g").attr("id", "axes"),
    dvc.xAxis = dvc.axes.append("line").attr("y2", dvc.height),
    dvc.yAxis = dvc.axes.append("line").attr("x2", dvc.width);
	
/*	svg.call(d3.behavior.drag()
			  .origin(function() { var r = projection.rotate(); return {x: r[0] / sens, y: -r[1] / sens}; })
			  .on("drag", function() {
				var rotate = projection.rotate();
				projection.rotate([d3.event.x * sens, -d3.event.y * sens, rotate[2]]);
				d3.selectAll("path").attr("d", path);
			  }));

*/

	d3.select("#mapGraticule").append("path")
        .datum(dvc.graticule)
        .attr("class", "graticule")
        .attr("d", dvc.path);
		

/*d3.json("geo/world_countries.json", function(collection) {
  feature =d3.select("#mapPolygons").selectAll("path")
      		.data(collection.features)
    		.enter()
			.append("path")
			.attr("d",path)
			.attr("class","mapPoly")
			.on("mouseover", function(d) {return console.log(d.id);})
			.call(d3.behavior.drag()
			  .origin(function() { var r = projection.rotate(); return {x: r[0] / sens, y: -r[1] / sens}; })
			  .on("drag", function() {
				var rotate = projection.rotate();
				projection.rotate([d3.event.x * sens, -d3.event.y * sens, rotate[2]]);
				d3.selectAll("path").attr("d", path);
			  }));*/
			
			
// Load as a topojson file - rather than the GeoJson file */
			
/*      d3.json("geo/world2.json", function(error, world) {
		d3.select("#mapPolygons").selectAll("path")
			.data(topojson.feature(world, world.objects.countries).features)
			.enter()
			.append("path")
			.attr("d", path)
			.attr("class", "mapPoly")
			.on("mouseover", function(d) {return console.log(d.id);})
			.call(d3.behavior.drag()
			  .origin(function() { var r = projection.rotate(); return {x: r[0] / sens, y: -r[1] / sens}; })
			  .on("drag", function() {
				var rotate = projection.rotate();
				projection.rotate([d3.event.x * sens, -d3.event.y * sens, rotate[2]]);
				d3.selectAll("path").attr("d", path);
			  }));
	
*/    
//	  loadflow();
	 
$(document).ready(function(){	

		var filepth = 'geo/flow2.js';
	

	  
	  d3.json("geo/ewwithscot.json", function(error, world) {
		d3.select("#mapPolygons").selectAll("path")
			.data(topojson.feature(world, world.objects.layer1).features)
			.enter()
			.append("path")
			.attr("d", dvc.path)
			//.attr("title", function(d) { return d.properties.CNTRY_NAME;})
			.attr("class", "mapPoly")
			.attr("id", function(d) {return d.properties.LAD11CD})
			//.attr("data-cd", function(d) {return "[" + d3.geo.centroid(d) + "]"})
			.on("mouseover", function(d) {return sel(d.properties.LAD11CD)})
			.on("mouseout", function(d) {return removeSpider()});
			//.on("click", function(d) {return fixSpider(d.properties.LAD11CD)});
		
		
		d3.json(filepth, function(error, json) {
			if (error) return console.log(error);
			dvc.flowdata=json;
			countryopt();
			getCentroids();
			
		}); 
		
		
		
			  
	    //redraw();
     
	    dvc.globe2map = interpolatedProjection(dvc.projectionGlobe, dvc.projectionFlat);
  		dvc.map2globe = interpolatedProjection(dvc.projectionFlat, dvc.projectionGlobe);
			
		
	


//Build an arrowhead




//d3.select("body").append("svg").attr("id","defs").append("svg:defs").selectAll("marker")
//    .data(["end"])      // Different link/path types can be defined here
//  .enter().append("svg:marker")    // This section adds in the arrows
//    .attr("id", String)
//    .attr("viewBox", "0 -5 12 12")
//    .attr("refX", 5)
//    .attr("refY", 0)
//    .attr("markerWidth", 10)
//    .attr("markerHeight", 10)
//    .attr("orient", "auto")
//  .append("svg:path")
//    .attr("d", "M0,-3L6,0L0,3")
//	.attr("fill", "rgba(255,170,0,1)");
//	
//d3.select("#defs").append("svg:defs").selectAll("marker")
//    .data(["endCircle"])      // Different link/path types can be defined here
//  .enter().append("svg:marker")    // This section adds in the arrows
//    .attr("id", String)
//    .attr("viewBox", "-4 -4 12 12")
//    .attr("refX", 4)
//    .attr("refY", 4)
//    .attr("markerWidth", 8)
//    .attr("markerHeight", 8)
//    .attr("orient", "auto")
//  .append("circle")
//  	.attr("cx",4)
//	.attr("cy",4)
//	.attr("r", 4)
//	.attr("fill", "#59A4DA")
//	.attr("opacity",0.5);
	
	

			
//let's test drawing arcs between 2 locations...

	//create a layer to hold the arcs data
	//var arcs = d3.select("#mapSVG").append("g").attr("id", "mapArcs");
	
	
	//data for all citizenships

	//emigration 2012
	//myflow=[[-0.5,51.32],[135.20699,-25.86749]];//australia
	//myflow2=[[-0.5,51.32],[-104.00597,40.71435]];//usa	
	//myflow2=[[-0.5,51.32],[0.77969,45.1384]];//usa
	//myflow3=[[-0.5,51.32],[77.22496,28.63531]];//india
	//myflow4=[[-0.5,51.32],[101.47370,35.23042]];//china
	//myflow5=[[-0.5,51.32],[2.35222,45.85661]];//france
	
	//myflows=[[[-0.5,51.32],[135.20699,-25.86749]],[[-0.5,51.32],[-104.00597,40.71435]],[[-0.5,51.32],[77.22496,28.63531]],[[-0.5,51.32],[101.47370,35.23042]],[[-0.5,51.32],[2.35222,45.85661]]];
	
//	var path1 = arcs.append("path")
//	.attr("id","greatArc")
//	.datum({type: "LineString", coordinates: myflow})
//    .attr("class", "mapArcs")
//    .attr("d", path);
//	
//	var path2 = arcs.append("path")
//	.attr("id","greatArc")
//	.datum({type: "LineString", coordinates: myflow2})
//    .attr("class", "mapArcs")
//    .attr("d", path);
//	
//	var path3 = arcs.append("path")
//	.attr("id","greatArc")
//	.datum({type: "LineString", coordinates: myflow3})
//    .attr("class", "mapArcs")
//    .attr("d", path);
//	
//	var path4 = arcs.append("path")
//	.attr("id","greatArc")
//	.datum({type: "LineString", coordinates: myflow4})
//    .attr("class", "mapArcs")
//    .attr("d", path);
//
//	var path5 = arcs.append("path")
//	.attr("id","greatArc")
//	.datum({type: "LineString", coordinates: myflow5})
//    .attr("class", "mapArcs")
//    .attr("d", path);


//   var totalLength = path2.node().getTotalLength();
//
//   path2.attr("stroke-dasharray", totalLength + " " + totalLength)
//      .attr("stroke-dashoffset", totalLength)
//      .transition()
//      .duration(2000)
//      .ease("linear")
//      .attr("stroke-dashoffset", 0);
//   
//   
//   path3.attr("stroke-dasharray", totalLength + " " + totalLength)
//      .attr("stroke-dashoffset", totalLength)
//      .transition()
//      .duration(2000)
//      .ease("linear")
//      .attr("stroke-dashoffset", 0);
//	  
//   path4.attr("stroke-dasharray", totalLength + " " + totalLength)
//      .attr("stroke-dashoffset", totalLength)
//      .transition()
//      .duration(2000)
//      .ease("linear")
//      .attr("stroke-dashoffset", 0);
//	  
//	  
//   path5.attr("stroke-dasharray", totalLength + " " + totalLength)
//      .attr("stroke-dashoffset", totalLength)
//      .transition()
//      .duration(2000)
//      .ease("linear")
//      .attr("stroke-dashoffset", 0);
   });
   
 });
 
function getCentroids() {
			
			
			//centroid select cases where the centroid doesn't work
			
			centr = []
			
			centr['UK'] = ['[-1.41,52.7]'];
			centr['CI'] = ['[-72.94,-45.39]'];//Chili
			centr['CA'] = ['[-107.57,52.0]'];//Canada
			centr['US'] = ['[-101,39.23]'];//US
			centr['TH'] = ['[-1.41,52.7]'];//Thailand
			centr['NZ'] = ['[176,-39.27]'];//NZ
			centr['NO'] = ['[8.47,60.47]'];//Norway
			centr['GR'] = ['[22.06,39.19]'];//Greece
			centr['HR'] = ['[15.13,44.59]'];//Croatia
			
			centr['MY'] = ['[102.21,3.64]'];//Malaysia
     		centr['PP'] = ['[143.32,-5.78]'];//Papa New Guinea
			centr['NL'] = ['[6.3,53.1]'];//Netherlands
			
			
			
			
			
			d3.selectAll(".mapPoly")
			.attr("data-cd", function(d,i) {if(d.properties.LAD11CD == 'UK' || d.properties.LAD11CD == 'CI' || d.properties.LAD11CD == 'CA' || d.properties.LAD11CD == 'US' || d.properties.LAD11CD == 'TH' || d.properties.LAD11CD == 'NZ' || d.properties.LAD11CD == 'NO' || d.properties.LAD11CD == 'GR' || d.properties.LAD11CD == 'HR' || d.properties.LAD11CD == 'MY' || d.properties.LAD11CD == 'PP'  || d.properties.LAD11CD == 'NL')
					{return centr[d.properties.LAD11CD]} else 
					{return "[" + d3.geo.centroid(d) + "]"}
			
			
			});
			
			
		//Need to build an array of centroid pairings (& then sort by area code?)
		
		dvc.allcentroids = [];
		
		//d3.selectAll().attr("data-cd");
		
				
		d3.selectAll(dvc.flowdata.ons.area).each(function(d,i){
						
			dvc.allcentroids.push(d3.select("#" + dvc.flowdata.ons.area[i]).attr("data-cd"));		
							
		});
		
//		console.log(dvc.allcentroids);
//		console.log(dvc.order);
			
}
 
function countryopt () {

// Build option menu for country list

var countryzip = d3.zip(dvc.flowdata.ons.area, dvc.flowdata.ons.areaname);

var top = d3.select("#toppanel");
	
	//console.log(top.select("#areaselect"));
	
	controls = top.append("div").attr("id","controls");
	
	var optns = controls.append("div").attr("id","sel").append("select")
		.attr("id","areaselect")
		.attr("style","width:280px")
//		.attr("class","dropdown");
		.attr("class","chosen-select");
	
	//append message
	
	optns.append("option")
		.attr("value","first")
		.text("");
		//.attr("selected", "selected");
	
	optns.selectAll("p").data(countryzip).enter().append("option")
		.attr("value", function(d){ return d[0]}) /* Optional */
		.text(function(d){ return d[1]});
		
	
	$('#areaselect').chosen({width: "280px",allow_single_deselect: true,}).on('change',function(evt,params){
		
							
						if(typeof params != 'undefined') {
							
						
						
						if(dvc.selection==true) {
							d3.select("#int" + dvc.currentbar).attr("class","intBar")
							unhighmatch()
						}
								
						dvc.currentbar=this.value;
						freeze();
						
						}
						else {
							
							d3.select("#int" + dvc.currentbar).attr("class","intBar")
						    unhighmatch();
							enablehover();
							revertsel(dvc.preselect);
						}
	});
	
	
	
	
	
	
	
	
	//$('#areaselect').selectric();
	
//	$('#areaselect').change(function(){
//		highlight(this.value)
//	});	
	
	flowselect()
	
	top.append("h2")
		.attr("id","titlepanel")
		.text(dvc.flowdata.ons.name);
		
		

	
}



function freeze () {
		d3.select("#int" + dvc.currentbar).attr("class","intBarActive")
		//d3.select("#mainTimeChart").remove();
		appendarc();
		dvc.selection = true;
		disablehover();

}


function disablehover () {
	
	d3.selectAll(".polyhigh").attr("pointer-events","none");
	d3.selectAll(".mapPoly").attr("pointer-events","none");
	d3.selectAll("#mainChart").attr("pointer-events","none");
		
}


function enablehover () {
	dvc.selection = false;
	d3.selectAll(".mapPoly").attr("pointer-events","all");
	d3.selectAll("#mainChart").attr("pointer-events","all");
}


// Build time label top right

//function time(){
//
//	//Give me a little label showing the currently selected/moused area
//	
//	d3.select("#mapSVG").append("text").attr("id","curryear").attr("x",10).attr("y",85).attr("text-anchor","start").text(dvc.flowdata.ons.timeLabels[dvc.timeIndex]);
//	
//}
//
//function timeUpdate(){
//
//	//Give me a little label showing the currently selected/moused area
//	
//	d3.select("#curryear").text(dvc.flowdata.ons.timeLabels[dvc.timeIndex]);
//	
//}


/**********************/
/* Time Slider 		  */

function timeSlider() {

dvc.timeP = dvc.flowdata.ons.timeLabels[dvc.timeIndex];

dvc.time = d3.select("#mapDiv").append("div").attr("id","currtime");

dvc.time.attr("x",10).attr("y",40).text(dvc.timeP);

d3.select("#sliderTime").append("div").attr("id","slider").call(d3.slider().on("slide", function(evt, value) {
      dvc.timeP=value;
	  changetext(value);
	  if(dvc.selection==true) {
	  	freeze();
	  }
    }).axis(true).min(2002).max(2012).step(1).value(2012/*dvc.flowdata.ons.timeLabels[dvc.timeIndex]*//*Seems to cause problems with the slider for some reason - in that it requires you to have dragged the slider */));
	
d3.select("#slider").select("div").attr("tabindex", 3).attr("onkeydown", "keyDown(event)");
	
dvc.timeMin = 0;
dvc.timeMax = dvc.flowdata.ons.timeLabels.length - 1;

}

function keyDown(event){
//on press of left arrow key decrease time index by 1 (if not at slider minimum) 
//and move slider handle to new position

	


	if( event.keyCode == 37){
		if (dvc.timeIndex>0){	
			dvc.timeIndex--
			dvc.timeP--
			var year = dvc.timeIndex+dvc.timeMin;
			var formatPercent = d3.format(".2%");
			var scale = d3.scale.linear().domain([dvc.timeMin, dvc.timeMax]);
			d3.select("#slider").select(".d3-slider-handle")
				.style("left", formatPercent(scale(year)));
		}	
	} else if ( event.keyCode == 39 ){ 
//on press of right arrow key increase time index by 1 (if not at slider maximum) 
//and move slider handle to new position
		if (dvc.timeIndex<dvc.timeMax){	
			dvc.timeIndex++
			dvc.timeP++
			var year = dvc.timeIndex+dvc.timeMin;
			var formatPercent = d3.format(".2%");
			var scale = d3.scale.linear().domain([dvc.timeMin, dvc.timeMax]);
			d3.select("#slider").select(".d3-slider-handle")
				.style("left", formatPercent(scale(year)));
		}
				
	} 
//apply functions to update graphic
	  			
	  changetext(dvc.timeP);
	  if(dvc.selection==true) {
	  	freeze();
	  }
}


function changetext(){
	
    var timeInd = dvc.flowdata.ons.timeLabels.indexOf(JSON.parse('"' + dvc.timeP + '"'));
	dvc.timeIndex = timeInd;
	dvc.ddselect=true;
	
	
	dvc.time.attr("x",30).attr("y",40).text(dvc.timeP);
	d3.select("#arealab").html(dvc.fixareaname + "<span style='font-size:18px;'> </span>");
	
	
	
	if(dvc.fix==true) {
		
		
		removeSpiderFix(); 
		
		dvc.areacode=dvc.fixareacode;
		dvc.position = dvc.flowdata.ons.area.indexOf(dvc.areacode);
		dvc.areaname = dvc.flowdata.ons.areaname[dvc.position];

		
		arrays()
		
	};
	
	
}

// OLD HIGHLIGHT FUNCTION WHICH ROTATED GLOBE TO REFOCUS AREA BASED ON COUNTRY SELECTION - IMPORTANT

//function highlight(){
//      
//	  d3.select(".polyhigh").classed("polyhigh",false).classed("mapPoly",true);
//	  
//      var ar = d3.select("#" + this.value);
//	  ar.classed("mapPoly",false);
//	  ar.classed("polyhigh",true);
//	  
//	  p = JSON.parse(ar.attr("data-cd"));
//	  
//      rotate(p);
//	  
//}


function highlight(area){
	//console.log(area);
	dvc.areacode = area;
	dvc.position = dvc.flowdata.ons.area.indexOf(dvc.areacode);
	dvc.areaname = dvc.flowdata.ons.areaname[dvc.position];
	
	dvc.fix=true;
	dvc.ddselect=true;
	removeSpiderFix();
	
	arrays();

	  
}


function rotate(p) {
	
	d3.transition()
      .duration(2500)
      .tween("rotate", function() {
        var r = d3.interpolate(dvc.projection.rotate(),[-p[0], -p[1]]);
        return function(t) {
          dvc.projection.rotate(r(t));
		  dvc.svg.selectAll("path").attr("d", dvc.path);
        };
    });
	
}

/* Code to centre globe and unravel to flat projection */
function defaultRotate() {
	
	dvc.svg.transition().duration(1000)
	.attr("viewBox", "250 -70 " + 940 + "  "+ dvc.height)

//	  d3.transition()
//		.duration(1500)
//		.tween("rotate", function() {
//		  var r = d3.interpolate(dvc.projection.rotate(), [[0.3,-54]]);
//		  return function(t) {
//			dvc.projection.rotate(r(t));
//			dvc.svg.selectAll("path").attr("d", dvc.path);
//		  };
//	  });
}
	
	
	
function interpolatedProjection(a, b) {
    var projection = d3.geo.projection(raw).scale(1),
    center = projection.center,
    translate = projection.translate,
    clip = projection.clipAngle,
    α;
    
    function raw(λ, φ) {
      var pa = a([λ *= 180 / Math.PI, φ *= 180 / Math.PI]), pb = b([λ, φ]);
      return [(1 - α) * pa[0] + α * pb[0], (α - 1) * pa[1] - α * pb[1]];
    }
    
    projection.alpha = function(_) {
      if (!arguments.length) return α;
      α = +_;
      var ca = a.center(), cb = b.center(),
      ta = a.translate(), tb = b.translate();
      center([(1 - α) * ca[0] + α * cb[0], (1 - α) * ca[1] + α * cb[1]]);
      translate([(1 - α) * ta[0] + α * tb[0], (1 - α) * ta[1] + α * tb[1]]);
      if (dvc.clipMode === true) {clip(180 - α * 90);}
      return projection;
    };
    
    delete projection.scale;
    delete projection.translate;
    delete projection.center;
    return projection.alpha(0);
  }



  function trans() {
	  defaultRotate();
   	//Transforming Map to Globe
	 
	 setTimeout(function() {

		zoom = d3.behavior.zoom()
			  .translate(dvc.projectionFlat.translate())
			  .scale(dvc.projectionFlat.scale())
			  .scaleExtent([20500, 60000])
			  .on("zoom", redraw);
		
		
	 	dvc.svg.call(zoom); 
			  
		//redraw()
		
		
		}
	 , 2000);
	 
	 //Add text to box in left hand corner detailing in/out/net
	 
	   d3.select("#lefttop").append("p").attr("id","arealab").html(dvc.fixareaname + "<span style='font-size:18px;'> </span>");
		
					leftp = d3.select("#leftp");
					
					leftp.selectAll('p')
							.data(dvc.flowdata.ons.dataType)
							.enter()
							.append('p')
							.attr('class', 'leftLabels')
							.style('left', '10px')
							.style('top', function(d, i){ return ((i *50) + 15) + 'px';})
							.text(function(d){ return d + ':'; });
	 
	 //add three paragraphs then append three span elements
	 				leftp.selectAll('h1')
							.data(dvc.flowdata.ons.dataType)
							.enter()
							.append('p')
							.attr('class', 'leftFigures')
							.style('right', '10px')
							.style('top', function(d, i){ return ((i *50) + 15) + 'px';});
					
					var leftfig = d3.selectAll(".leftFigures");
					
							leftfig.append("span").attr('id', function(d,i) {return "leftfigprefix" + i}).text('£')
							leftfig.append("span").attr('id', function(d,i) {return "leftfig" + i}).text("0.0")
							leftfig.append("span").attr('class',"leftunit").text("");
								 
		}
  
// function animation(interProj) {
//    d3.selectAll("path").transition()
//    .duration(7500)
//    .tween("projection", function() {
//      return function(_) {
//        interProj.alpha(_);
//      };
//    })
//  }


//
//	function change() {
//	  update(options[this.selectedIndex]);
//	}		
//	
//	function update(option) {
//		
//	  if(option.name == "Orthographic") {	
//	
//	  d3.selectAll("path").transition()
//		  .duration(750)
//		  .attrTween("d", projectionTweenOrtho(projection, projection = option.projection));
//	  
//	  } else {
//	
//	  
//	}
//	
	function projectionTween(projection0, projection1) {
	  return function(d) {
		var t = 0;

	   var projection = d3.geo.projection(project).scale(1);
			//.translate([width / 2, height / 2]);
	
		var path = d3.geo.path()
			.projection(projection);
	
		function project(λ, φ) {
		  λ *= 180 / Math.PI, φ *= 180 / Math.PI;
		  var p0 = projection0([λ, φ]), p1 = projection1([λ, φ]);
		  return [(1 - t) * p0[0] + t * p1[0], (1 - t) * -p0[1] + t * -p1[1]];
		}
	
		return function(_) {
		  t = _;
		  return path(d);
		};
	  };
	}
//
//	
//	/*Special Case for orthographic projection which needs clipping */
//
//	function projectionTweenOrtho(projection0, projection1) {
//	  return function(d) {
//		var t = 0;
//
//		var projection = d3.geo.projection(project)
//			//.rotate([70,-40])
//			.scale(0.9)
//			.translate([width / 2, height / 2])
//			.clipAngle(90)
//			.precision(0.1);
//	
//		var path = d3.geo.path()
//			.projection(projection);
//	
//		function project(λ, φ) {
//		  λ *= 180 / Math.PI, φ *= 180 / Math.PI;
//		  var p0 = projection0([λ, φ]), p1 = projection1([λ, φ]);
//		  return [(1 - t) * p0[0] + t * p1[0], (1 - t) * -p0[1] + t * -p1[1]];
//		}
//	
//		return function(_) {
//		  t = _;
//		  return path(d);
//		};
//	  };
//	}	
    
		
	function redraw() {
	  if (d3.event) {
		dvc.projectionFlat
			.translate(d3.event.translate)
			.scale(d3.event.scale);
			//console.log("I've entered here")
	  }
	    
	 
	  
	  var t = dvc.projectionFlat.translate();
	  	  
	  dvc.xAxis.attr("x1", t[0]).attr("x2", t[0]);
	  dvc.yAxis.attr("y1", t[1]).attr("y2", t[1]);
	  
	  dvc.svg.selectAll("path").attr("d", dvc.path);
	  
	
	}	
	
	
	
	
	// Build flow option menu (eg in, out, net)
	function flowselect(){
		
	d3.select("#controls")
		.append("form")
		.append("div")
		.attr("id","flowtype")
		.attr("left", dvc.width - 150 + "px");
		
	d3.selectAll(dvc.flowdata.ons.dataType).each(function(d,i){
		$('<input type="radio" name="radio" id="flow' + i +'"/>').appendTo('#flowtype');
		$('<label for="flow' + i + '">' + dvc.flowdata.ons.dataType[i] + '</label>').appendTo('#flowtype');
		
	});
	
	d3.select("#" + dvc.flow).attr("checked", "checked");
		
	$("#flowtype").buttonset()
		.change(function() { 	
		dvc.flow=$("#flowtype :radio:checked").attr("id");
		dvc.flowname = $('#flowtype :radio:checked').next('label:first').text();
		d3.select('#middletop').text(dvc.flowname);
		if(dvc.fix==true) {removeSpiderFix(); definearray();}
		if(dvc.selection==true) {
			freeze();
		}
	});
	
	
	}

	
	/* rotate globe for story */
	
	function projectionnext() {
		
		d3.transition()
    		.duration(1500)
    		.tween("rotate", function() {
      		var r = d3.interpolate(dvc.projection.rotate(), [280, -40]);
			return function(t) {
        	dvc.projection.rotate(r(t));
			dvc.svg.selectAll("path").attr("d", dvc.path);
			
      };
	  })

	
	}
	
	function projectionprev() {
		
		d3.transition()
    		.duration(1500)
    		.tween("rotate", function() {
      		var r = d3.interpolate(dvc.projection.rotate(), [70, -40]);
			return function(t) {
        	dvc.projection.rotate(r(t));
			dvc.svg.selectAll("path").attr("d", dvc.path);
			};
		})	
	}
	
	/* Understand what flow is selected */
	
	/* Set default checked state to in (imports/migration etc) */

	
	/* On-click overwrite variable with selection */

	
	/* Create the relevant flow lines when hovering over a country */
	
	function sel(d) {
		
		//get country code for country currently mousing over
		//console.log(d);
		
		dvc.areacode=d;
		dvc.position = dvc.flowdata.ons.area.indexOf(dvc.areacode);
		dvc.areaname = dvc.flowdata.ons.areaname[dvc.position];
		
		arrays();
	}
	
	function arrays() {
		
		if (dvc.fix==false || (dvc.fix==true && dvc.ddselect==true)) {
		
		dvc.ddselect=false;
		
		//get it's position in the dvc.flowdata.ons file
		//console.log(position)
		//Now we know it's position we can get get an array of data for that area
		//This is just the row number for imports
		//console.log(dvc.flowdata.ons.dataValues[position]); //imports
		dvc.areaname = dvc.flowdata.ons.areaname[dvc.position];
		
		var into = dvc.flowdata.ons.dataValues[dvc.position];
		
		//For exports we need to build a new array taking the i'th value from each row array
		//We may as well build the net flow whilst we're here
		
		var out = [];
		var net = [];
		for(j=i=0; i<dvc.flowdata.ons.areaname.length; i++) {
			  
			  out.push(dvc.flowdata.ons.dataValues[i][dvc.position]);
			  net[i]=[];
			  			  
			  for(j=0; j<dvc.flowdata.ons.timeLabels.length; j++){
	
					net[i].push(dvc.flowdata.ons.dataValues[i][dvc.position][j] - dvc.flowdata.ons.dataValues[dvc.position][i][j]);
					
			  };
			  
    	};
		
				
		//AT THIS POINT I NEED TO BUILD AN ARRAY WHICH HAS BOTH DATA AND COUNTRIES SO THAT I CAN SORT AND KEEP THE ORDER THE SAME? OR DO I JUST SORT THE ARRAY THEN FIND THE VALUE AT WHICH IT BREAKS? PROBABLY NOT BECAUSE THAT WOULD MEAN WE COULDN"T DRAW BY ORDER
		
		//I'm going to create 3 arrays in, out and net - keeping pairs of value and country only for instances where data > 0
	
	
		
		
//		dvc.infilter = [];
//		
//		for(i=0; i<into.length; i++){
//			if(into[i].slice(dvc.timeIndex, dvc.timeIndex +1) > 0) {	
//				dvc.infilter.push(d3.merge(d3.zip(into[i].slice(dvc.timeIndex, dvc.timeIndex +1), dvc.flowdata.ons.area[i])));
//			}
//		}

		//AT THIS POINT GENERATE TWO TYPES OF ARRAYS
		
		// 1) ONE FOR THE MAP WHICH HAS JUST THAT YEARS DATA, WITH THE COUNTRY CODE 
	dvc.infilter = d3.zip(into.map(function(value, index) {return value[dvc.timeIndex]}), dvc.flowdata.ons.area, dvc.allcentroids).filter(function(d) { return d[0] > 0; });
	dvc.outfilter = d3.zip(out.map(function(value, index) {return value[dvc.timeIndex]}), dvc.flowdata.ons.area, dvc.allcentroids).filter(function(d) { return d[0] > 0; });		
	dvc.netfilter = d3.zip(net.map(function(value, index) {return value[dvc.timeIndex]}), dvc.flowdata.ons.area, dvc.allcentroids).filter(function(d) { return d[0] != 0;});
	
		// 2) ONE FOR THE TIME SERIES CHART WHICH HAS ALL YEARS DATA - SORT ORDER UNIMPORTANT - KEEP NATURAL TIME ORDER
		
		dvc.flow0time = into;
		dvc.flow1time = out;
		dvc.flow2time = net;
		
		
		
		// Sort set of arrays for map and for chart (aid's drawing order for arcs and data needs to be sorted for significance testing);
				
		dvc.flow0 = dvc.infilter.sort(function(a, b){ return d3.descending(a[0], b[0]) });/*IN*/
		dvc.flow1 = dvc.outfilter.sort(function(a, b){ return d3.descending(a[0], b[0]) });/*OUT*/
		dvc.flow2 = dvc.netfilter.sort(function(a, b){ return d3.descending(a[0], b[0]) });/*NET*/
		
		
		
		dvc.flow0un = [];
		dvc.flow1un = [];
		flow2unsort = [];
		
		d3.selectAll(dvc.flow0).each(function(d,i){
			dvc.flow0un.push(dvc.flow0[i][0]);					
		});
		
		d3.selectAll(dvc.flow1).each(function(d,i){
			dvc.flow1un.push(dvc.flow1[i][0]);					
		});
		
		
		
		d3.selectAll(dvc.flow2).each(function(d,i){
			if (dvc.flow2[i][0]>=0){
				flow2unsort.push(dvc.flow2[i][0]);
			} else {
				flow2unsort.push(dvc.flow2[i][0]*-1);
			}
		});
		
		
		dvc.flow2un = flow2unsort.sort(function(a, b){ return d3.descending(Math.abs(a), Math.abs(b)); });

		
			
		//USE D3.zip to join all arrays.  zipped = d3.zip(dvc.flowdata.ons.dataValues[position],dvc.flowdata.ons.area);
		//var  flows = d3.zip(into /*imports*/, out /*exports*/, net /*net*/,  dvc.flowdata.ons.area/*area_code*/);
		
		// Get the coordinates once for this country 
		
		dvc.coordsfrom = d3.select("#" + dvc.areacode).attr("data-cd");
		
		
		
		// Get the Total flows (in, out and net) for the country you're hovering over
		
//		dvc.totals = dvc.flowdata.ons.totals[dvc.position];
//		dvc.totalsin = dvc.totals[0];
//		dvc.totalsout = dvc.totals[1];
//		dvc.totalsnet = dvc.totals[2];
		
//		makeTimeChart(dvc.totalsin,dvc.totalsout,dvc.totalsnet);
		
		d3.select("#arealab").html(dvc.areaname + "<span style='font-size:18px;'> </span>");
		// get current state - are we looking at in, out, or net flows?
		definearray();
	    
		
		}
		
		else if (dvc.fix==true && dvc.ddselect==false) {
		
			//d3.select("#bar" + dvc.areacode).attr("class","chartBarSel");
			d3.select("#int" + dvc.areacode).attr("class","intBarActive");
			
			dvc.arc = d3.select("#arc" + dvc.areacode);
			dvc.currclass = dvc.arc.attr("class");
			dvc.arc.attr("class", dvc.currclass + " mapArcsSel");
//			dvc.arc = arcs.append("path")
//				  .attr("d", d3.select("#arc" + dvc.areacode).attr("d"))
//				  .attr("id", "arcSelection")
//				  .attr("pointer-events", "none")
//				  .style("fill", "none")
//				  .style("stroke", "rgba(255, 127, 0,0.3)")
//				  .style("stroke-width", 3);
				  
			d3.select("#arealab").html(dvc.fixareaname + "<span style='font-size:18px;'> trade with</span> " + dvc.areaname);
	
			makeTimeChart(dvc.flow0time[dvc.position],dvc.flow1time[dvc.position],dvc.flow2time[dvc.position]);
			
		}
		
	};

	
	function definearray () {
		
		arraynm=eval("dvc." + dvc.flow);
		
		dvc.jmtothemax = calculateMyIndexYieldingMaxPearsons(eval("dvc." + dvc.flow + "un"));
		//console.log(dvc.jmtothemax);
		spider(arraynm);
		
	}

	function spider(arraynm){
		if(dvc.storyover=true)	{
			makeChart(arraynm);
			
		}
	
	arraynm.reverse();
	
	arcs = dvc.svg.append("g").attr("id", "mapArcs");
	arcsLow = arcs.append("g").attr("id","mapArcsLow");
	arcsHigh = arcs.append("g").attr("id","mapArcsHigh");
	// look at the length of your data array
	
	lines = [];
	
	for(i=0; i<=arraynm.length-1; i++) {
		lines.push({
			type: "LineString",
			coordinates: JSON.parse("[" + arraynm[i][2] + "," + dvc.coordsfrom + "]")
		});
	
		
	}
	
	var arrlength = arraynm.length;
	
//	console.log(lines);
	
	d3.select("#mapArcs").selectAll(".mapArcsLow")
		.data(lines)
		.enter()
		.append("path")
		.attr("id",function(d,i) {return "arc" + arraynm[i][1]}) 
		.attr("class",function(d,i) {if(arraynm[i][0] >= dvc.jmtothemax || arraynm[i][0] <= (dvc.jmtothemax*-1)){return "mapArcsHigh"} else {return "mapArcsLow"} }) 
		.attr("stroke",function(d,i) {if(arraynm[i][0] >= dvc.jmtothemax || arraynm[i][0] <= (dvc.jmtothemax*-1)){return "rgba(255,127,0,1)"} else {return "rgba(89,164,218,0.5)"} })
		.attr("d",dvc.path)
		.attr("pointer-events", "none");
		
//		
//						arcsHigh.append("path")
//							.attr("id","arc" + arraynm[i][1])
//							.datum({type: "LineString", coordinates: coords})
//							.attr("class", "mapArcsHigh")
//							.attr("d", dvc.path)
//							.attr("stroke","rgba(255,127,0,1)")
//							.attr("data-val",arraynm[i][0])
//							.attr("pointer-events", "none");


	
//	for(i=arraynm.length-1; i>=0; i--) {
//			
//			
//	// use the coordinates which are attached to each polygon
//						
//			//var coordsto = d3.select("#" + arraynm[i][1]).attr("data-cd"); /* Sort out area geography codes */
//			var coordsto = arraynm[i][2];
//			
//			//MIGHT NEED TO CHANGE FOR ARROW HEAD DIRECTION - ARROW NEEDS TO BE IN AT THE END 
//			var coords = JSON.parse('[' + coordsto + ',' + dvc.coordsfrom + ']');//Use JSON parse to make it treat the string as JSON
//			var coordsopp = JSON.parse('[' + dvc.coordsfrom + ',' + coordsto + ']');
//			
//			
//			opac = ((0.8/arraynm.length)*(arraynm.length-(i-1))) + 0.01;
//			
//			
//	
//			
//			if(arraynm[i][0] >= dvc.jmtothemax || arraynm[i][0] <= (dvc.jmtothemax*-1)) {	
//		
//					
//					
//					if(dvc.flow=='flow0') {
//						
//						
//						arcsHigh.append("path")
//							.attr("id","arc" + arraynm[i][1])
//							.datum({type: "LineString", coordinates: coords})
//							.attr("class", "mapArcsHigh")
//							.attr("d", dvc.path)
//							.attr("stroke","rgba(255,127,0,1)")
//							.attr("data-val",arraynm[i][0])
//							.attr("pointer-events", "none");
//							
//					}
//					else if (dvc.flow=='flow1') {
//						
//						arcsHigh.append("path")
//							.attr("id","arc" + arraynm[i][1])
//							.datum({type: "LineString", coordinates: coordsopp})
//							.attr("class", "mapArcsHigh")
//							.attr("d", dvc.path)
//							.attr("stroke","rgba(255,127,0,1)")
//							.attr("data-val",arraynm[i][0])
//							.attr("pointer-events", "none");
//							
//					
//					}
//					
//					else  {
//						
//						if(arraynm[i][0]<0) {
//						
//						arcsHigh.append("path")
//							.attr("id","arc" + arraynm[i][1])
//							.datum({type: "LineString", coordinates: coordsopp})
//							.attr("class", "mapArcsHigh")
//							.attr("d", dvc.path)
//							.attr("stroke","rgba(204,0,0,0.8)")
//							.attr("data-val",arraynm[i][0])
//							.attr("pointer-events", "none");
//						}
//						
//						else {
//												
//						arcsHigh.append("path")
//							.attr("id","arc" + arraynm[i][1])
//							.datum({type: "LineString", coordinates: coords})
//							.attr("class", "mapArcsHigh")
//							.attr("d", dvc.path)
//							.attr("stroke","rgba(0,0,0,0.5)")
//							.attr("data-val",arraynm[i][0])
//							.attr("pointer-events", "none");
//						}
//						
//					}
//				
//			}	else {
//				
//				if(dvc.flow !=='flow2') {
//				
//				arcsLow.append("path")
//					.attr("id","arc" + arraynm[i][1])
//					.datum({type: "LineString", coordinates: coords})
//					.attr("class", "mapArcsLow")
//					.attr("d", dvc.path)
//					.attr("opacity", opac)
//					//.attr("stroke", "rgba(89,164,218,0.5)")
//					.attr("stroke", "rgba(89,164,218," + opac + ")")
//					.attr("data-val",arraynm[i][0])
//					.attr("pointer-events", "none");
//					//.attr("marker-end", "url(#endCircle)")
//					//.attr("marker-start", "url(#endCircle)");
//				}
//				
//				else {
//						if(arraynm[i][0]<0) {
//						
//						arcsLow.append("path")
//							.attr("id","arc" + arraynm[i][1])
//							.datum({type: "LineString", coordinates: coords})
//							.attr("class", "mapArcsLow")
//							.attr("d", dvc.path)
//							.attr("stroke","rgba(204,0,0,0.5)")
//							.attr("data-val",arraynm[i][0])
//							.attr("pointer-events", "none");
//						}
//						
//						else {
//												
//						arcsLow.append("path")
//							.attr("id","arc" + arraynm[i][1])
//							.datum({type: "LineString", coordinates: coords})
//							.attr("class", "mapArcsLow")
//							.attr("d", dvc.path)
//							.attr("stroke","rgba(0,0,0,0.5)")
//							.attr("data-val",arraynm[i][0])
//							.attr("pointer-events", "none");
//						}
//					
//				}
//			
//			}
//	
//	}

	animatepath();	
						
	
		
	}
	
	function animatepath () {
						
					d3.selectAll(".mapArcsHigh").transition()
							.duration(500000)
							.ease("linear")
							.attr("stroke-dashoffset", -4000 )
							.each("end", animatepath);
	}
	
	function removeSpider() {

			if (dvc.fix==false) {	
			
				d3.select("#mainChart").remove();
			
				dvc.svg.selectAll("#mapArcs").remove();
				
			}
			
			else if (dvc.fix==true) {
				//d3.select("#bar" + dvc.areacode).attr("class","chartBars");
				d3.select("#int" + dvc.areacode).attr("class","intBar");
				dvc.arc.attr("class",dvc.currclass);
				revertsel(dvc.preselect);
				//d3.select("#mainTimeChart").remove();
			}
	}
	
	function revertsel (d) {
		
		dvc.areacode=d;
		dvc.position = dvc.flowdata.ons.area.indexOf(dvc.areacode);
		dvc.areaname = dvc.flowdata.ons.areaname[dvc.position];
		
		
		dvc.totals = dvc.flowdata.ons.totals[dvc.position];
		dvc.totalsin = dvc.totals[0];
		dvc.totalsout = dvc.totals[1];
		dvc.totalsnet = dvc.totals[2];
		
		makeTimeChart(dvc.totalsin,dvc.totalsout,dvc.totalsnet);
		d3.select("#arealab").html(dvc.fixareaname + "<span style='font-size:18px;'> </span>");
	}
	
	function removeSpiderFix() {
		
			
				d3.select("#mainChart").remove();
				dvc.svg.selectAll("#mapArcs").remove();
				

	}
	
	function fixSpider(area) {
		
		
		if (dvc.fix==false){
			dvc.fix = true;
			
			//record which area was clicked on
			
			
		
			dvc.fixareacode=area;
			var position = dvc.flowdata.ons.area.indexOf(area);
			dvc.fixareaname = dvc.flowdata.ons.areaname[position];
			
			
			
		}
		
		else {
			
			dvc.fix = false;
			
		}
	}
	
	
	function clearFix(){
		
		dvc.fix=false;
		
		removeSpider()
		
		
	}

	
	
/******SIGNIFICANCE TESTING **** LIFTED FROM INTERNAL MIGRATION EXAMPLE **********/


function calculateMyIndexYieldingMaxPearsons(myInputArray)

{

	dvc.myInputDivisor			= myInputArray.length;
	
	var myInputSum 				= calculateMyArraySum(myInputArray);

	var myInputMean				= myInputSum/dvc.myInputDivisor;

	var myYIMinusYBarArray 			= calculateMyElementMinusMyMeanArray(myInputArray,myInputMean);

	var myYIMinusYBarSquaredArray 		= multiplyTwoArrays(myYIMinusYBarArray,myYIMinusYBarArray);

	var mySigmaYIMinusYBarSquared		= calculateMyArraySum(myYIMinusYBarSquaredArray);

	var mySqrtSigmaYIMinusYBarSquared 	= Math.sqrt(mySigmaYIMinusYBarSquared);



	var myPearsonsRSquaredMax=-10000000000000;

	var myJMax=0;

	for (j=0;j<myInputArray.length;j++)

	{ 

		var myCycleArray 			= calculateMyCycleArray(myInputSum,j,myInputArray.length);

		var myCycleDivisor			= myCycleArray.length;

		var myCycleSum 				= calculateMyArraySum(myCycleArray);	

		var myCycleMean				= myCycleSum/myCycleDivisor;

		var myXIMinusXBarArray 			= calculateMyElementMinusMyMeanArray(myCycleArray,myCycleMean);

		var myXIMinusXBarSquaredArray 		= multiplyTwoArrays(myXIMinusXBarArray,myXIMinusXBarArray);

		var mySigmaXIMinusXBarSquared		= calculateMyArraySum(myXIMinusXBarSquaredArray);

		var mySqrtSigmaXIMinusXBarSquared 	= Math.sqrt(mySigmaXIMinusXBarSquared);

		var myPearsonsRDivisor 			= mySqrtSigmaXIMinusXBarSquared * mySqrtSigmaYIMinusYBarSquared;

		var myXIMinusXBarTimesYIMinusYBarArray 	= multiplyTwoArrays(myXIMinusXBarArray,myYIMinusYBarArray);

		var mySigmaXIMinusXBarTimesYIMinusYBar	= calculateMyArraySum(myXIMinusXBarTimesYIMinusYBarArray);

		var myPearsonsR				= mySigmaXIMinusXBarTimesYIMinusYBar/myPearsonsRDivisor;

		var myPearsonsRSquared			= myPearsonsR*myPearsonsR

		if (myPearsonsRSquared>=myPearsonsRSquaredMax) {myPearsonsRSquaredMax=myPearsonsRSquared;myJMax=myInputArray[j];}

	}

	return(myJMax);

}



function calculateMyArraySum(myInputArray)

{

	m=1000000;

	myArraySum = 0;

	for (i=0;i<myInputArray.length;i++)

	{ 

	myArraySum = ((myArraySum*m) + (myInputArray[i]*m))/m;

	}

	return(myArraySum);

}	





function calculateMyElementMinusMyMeanArray(myInputArray,myInputMean)

{

		m=1000000;

		var myOutputArray = new Array();

		for (k=0;k<myInputArray.length;k++)

		{

			myOutputArray[k]=((myInputArray[k]*m)-(myInputMean*m))/m;

		}

		return(myOutputArray);

}



function multiplyTwoArrays(myInputArrayOne,myInputArrayTwo)

{

		m=1000000;

		var myOutputArray = new Array();

		for (k=0;k<myInputArrayOne.length;k++)

		{

			myOutputArray[k]=((myInputArrayOne[k]*m)*(myInputArrayTwo[k]*m))/(m*m);



		}

		return(myOutputArray);

}



function zipMultiplyMyArray(myInputArray,myInputNumber)

{

		m=1000000;

		var myOutputArray = new Array();

		for (k=0;k<myInputArray.length;k++)

		{

			myOutputArray[k]=((myInputArray[k]*m)*(myInputNumber*m))/(m*m);



		}

		return(myOutputArray);

}



function calculateMyCycleArray(myInputSum,j,myInputLength)

{

		m=1000000;

		var myCycleArray = new Array();

		for (k=0;k<j+1;k++)

		{

			myCycleArray[k]=(myInputSum*m)/((j+1)*m);

		}

		for (k=j+1;k<myInputLength;k++)

		{

			myCycleArray[k]=0;

		}

		return(myCycleArray);

}



	
	
/********CHARTING CODE *******************************************************************************/



	
		//make a chart function
		
		function makeChart(arraynm)
		{
			//LET'S FIND OUT MORE ABOUT THE DATA
			//find length of series
			
			dvc.index=d3.range(dvc.myInputDivisor);//the number of records as a d3.range object
			
			//dvc.geogLength=dvc.flowdata.ons.dataValues[0][0].length;//the number of geographic elements held in each bar
				
			
			//find minValue
			dvc.minValue = arraynm[dvc.myInputDivisor-1][0];//already sorted so you don't want to resort again
			//console.log("min is " + dvc.minValue);
			///find max values of entire arrays (so that scale is kept constant)(first value is max)
			//dvc.maxValue = arraynm[0][0];
			
			dvc.maxValue = arraynm[0][0];
			//console.log(dvc.maxValue);
			
			//console.log("max is " + dvc.maxValue);
			

			
			
			
			//create y axis scale
			dvc.yScale=d3.scale.linear()
				.domain([Math.min(0,dvc.minValue),dvc.maxValue])
				.range([dvc.chartHeight,0])
				.nice();
				
			//console.log(dvc.flow0.slice(1));
				
			//create ordinal scale for y axis
			dvc.xScale = d3.scale.ordinal()
				.domain(arraynm.slice(1))
				.rangeRoundBands([0, dvc.chartWidth], dvc.gapRatio);
				
			//for some reason, xScale.rangeBand is not reurning the right cellWidth so we manually calc here...	
			dvc.cellWidth=(1-dvc.gapRatio)*dvc.chartWidth/dvc.myInputDivisor;
			
						
			//set up svg and append containers for chart and axes
			mainChart = d3.select("#panel").append("svg")
				.attr("id","mainChart")
				.attr("viewBox", "0 0 340 210");
			
			mainChart.append("g")
				.attr("id","myAxes");
				
			mainChart.append('text')
				  .attr("class","yLabel")
				  .text(dvc.yaxisSize)
				  .attr("text-anchor", "start")
				  .attr("transform", "translate(10,"+(dvc.yPadding-10)+")");		
			
			//append text label
			
			d3.select("#lefttop").append("p").text("").attr("id","chartText");
			
			//create basic graph
			d3.select("#mainChart")
				.append("g")
				.attr("id","grpBars")
				.attr("transform", "translate(" + dvc.xPadding + "," + dvc.yPadding + ")");
			
			dvc.format = d3.format(".2s");
				
			//create main axis
			dvc.yAxisChar=d3.svg.axis()
					.scale(dvc.yScale)
					.orient("left")
					.ticks(8);
					
			d3.select("#myAxes").append("g")
				.attr("class","axis")
				.attr("transform","translate("+ dvc.xPadding + ", " + dvc.yPadding + ")")
				.call(dvc.yAxisChar);
				
				//create secondary axis
			dvc.yGrid=d3.svg.axis()
					.scale(dvc.yScale)
					.orient("left")
					.ticks(8)
					.tickSize(-(dvc.chartWidth));
					
			d3.select("#myAxes").append("g")
				.attr("class","grid")
				.attr("transform","translate(" + dvc.xPadding + "," + dvc.yPadding + ")")
				.call(dvc.yGrid);
				
				var bar = d3.select("#grpBars").selectAll(".bar")
					.data(arraynm)
					.enter().append("g")
					.attr("class", "bar")
					.attr("transform", function(d, i) { return "translate(" + dvc.yScale(i) + ",0 )"; });
					 
				bar.append("rect")
					.attr("class", function(d,i) {if(d[0] >= dvc.jmtothemax || d[0] <= (dvc.jmtothemax*-1)) {return "chartBarsHigh"} else {return "chartBars"}})
					.attr("id",function(d, i) { 
						return "bar" + d[1];
					})
					.attr("width", dvc.cellWidth)
					.attr("y", function(d) { 
						return dvc.yScale(Math.max(0, d[0]));
					})
					.attr("height", function(d)	{
						return Math.abs(dvc.yScale(d[0]) - dvc.yScale(0));
					});
 
				 //append some text to bar
//				bar.append("text")
//					.attr("x", function(d) {
//						return dvc.xScale(0)-30;
//					})
//					.attr("class","barText")
//					.attr("y", dvc.yScale.rangeBand() / 2)
//					.attr("dy", ".35em")
//					.text(function(d, i) { 
//					//what text do you want on the label?
//					return d[1]; //we'll have the names from catLabels please
//					});
				
					
			
					
				//add interaction bars...
				bar.append("rect")
					.attr("class","intBar")
					.attr("id", function(d,i)	{
						return "int" + d[1];
					})
					.attr("height",dvc.chartHeight)
					.attr("y",0)
					.attr("width",dvc.cellWidth)
					.on("mouseover",function(d)	{
						//d3.select(this).attr("class","intBarActive")
						highmatch(this);
						//var objName = d3.select(this).attr("data-nm");
					})
					.on("mouseout",function(d)	{
						d3.select(this).attr("class","intBar")
						unhighmatch(this);
						revertsel(dvc.preselect);
					});
//					.on("click",function(d)	{
//						var bar=$(this).siblings()[0];
//						var txt=$(this).siblings()[1];
//						var status=d3.select(bar).attr("class");
//						if (status=="chartBars")
//						{
//							d3.select(bar).attr("class","chartBarSel");
//							d3.select(txt).attr("class","selText");
//						}	else
//						{
//							d3.select(bar).attr("class","chartBars");
//							d3.select(txt).attr("class","barText");
//						}	
//					})
							
			//add the area to display
//			d3.select("#mainChart").append("text")
//				.text(dvc.chartData.ons.area.label[dvc.timeIndex])
//				.attr("id","txtTime")
//				.attr("x", dvc.chartWidth*1.18)
//				.attr("y", 100)
//				.attr("pointer-events","none");
			
			//having sized and position the x for the bars, we now need to sort them into the default starting year
			/*dvc.index.sort(function(b, a) {
				return dvc.chartData.ons.value[a][dvc.timeIndex] - dvc.chartData.ons.value[b][dvc.timeIndex];
			})*/		
			dvc.xScale.domain(dvc.index);
			bar.attr("transform", function(d, i) {
					return "translate(" + dvc.cellWidth* i +"," + 0  + ")";
			});
			
			
			/*Select bar in chart*/
			d3.selectAll(".chartBarSel").attr("class", "chartBars");
			d3.select("#bar" + dvc.first).attr("class", "chartBarSel");	
				
			
			// create a key
						
			
					
		}//end of makeChart

		               function makeTimeChart(flow0, flow1, flow2) 
                { 
                        
                        if(dvc.firsttime == true) { 
                                dvc.firsttime = false; 
                        
                        //LET'S FIND OUT A BIT MORE ABOUT THE DATA 
                        //find out number of time points 
                        
                        dvc.timeLength=flow0.length; //the number of years in the dataset 
                                                                
                                widthTime = 320, 
                                heightTime =120, 
                                paddingXTime=40, 
                                paddingYTime=70,         
                                paddingXright=60; 
                                                                                                                                                        
                                maxIn=d3.max(flow0); 
                                maxOut=d3.max(flow1); 
                                maxOv=d3.max([maxIn, maxOut]); 
                                

                         xScaleTime=d3.scale.ordinal() 
                                                .domain(dvc.flowdata.ons.timeLabels) 
                                                .rangePoints([0,widthTime-paddingXright]);         

                        
                        
                     
                        
                        yScaleTime=d3.scale.linear() 
                                .domain([0,maxOv]) 
                                .range([heightTime,0]) 
                                .nice();         

                                                                        
                           xAxisTime=d3.svg.axis() 
                                                        .scale(xScaleTime) 
                                                        .orient("bottom") 
                                                        //.tickFormat(formatxAxisTime) 
                                                        .tickValues(xScaleTime.domain().filter(function(d, i) { return !(i % 2); }));                                                 

                        mainTimeChart = d3.select("#panel").append("svg") 
                                .attr("id","mainTimeChart") 
                                .attr("viewBox", "0 0 313 210"); 
                                
                                
                        var legend = mainTimeChart.selectAll('g') 
                                                        .data(dvc.flowdata.ons.dataType) 
                                                        .enter() 
                                                  .append('g') 
                                                        .attr('class', 'legend'); 
                                        
                                                legend.append('rect') 
                                                        .attr('x', function(d, i){ return (i * 70) + 173;}) 
                                                        .attr('y', 57) 
                                                        .attr('width', 13) 
                                                        .attr('height', 2) 
                                                        .style('fill', function(d,i) { return dvc.flowdata.ons.dataTypeColour[i]}); 
                                        
                                                legend.append('text') 
                                                        .attr('x', function(d, i){ return (i * 70) + 193;}) 
                                                        .attr('y', 61) 
                                                        .text(function(d){ return d; }); 

                        mainTimeChart.append('text') 
                                  .attr("class","yLabel") 
                                  .text(dvc.yaxisSize) 
                                  .attr("text-anchor", "start") 
                                  .attr("transform", "translate(" + (paddingXTime-30)+","+(paddingYTime-10)+")");                                         
                                        
//                        mainTimeChart.selectAll("yGridsTime") 
//                                                .data(yScaleTime.ticks(5)) 
//                                                .enter().append("line") 
//                                                .attr("class", "yGridsTime") 
//                                                .attr("x1", 0) 
//                                                .attr("y1", function(d){return yScaleTime(d)})         
//                                                .attr("x2", widthTime-paddingXright) 
//                                                .attr("y2", function(d){return yScaleTime(d)}) 
//                                                .attr("transform", "translate("+paddingXTime+","+paddingYTime+")");                 
                                                                                        
                        mainTimeChart.append('g').attr("class", "axis") 
                                                        .attr("id", "xAxisTime") 
                                                        .attr("transform", "translate(" + paddingXTime + ","+(paddingYTime+heightTime)+")") 
                                                        .call(xAxisTime);                                         
                          
                        yAxisTime=d3.svg.axis() 
                                                        .scale(yScaleTime) 
                                                        .orient("left") 
                                                        .ticks(5); 

                        mainTimeChart.append('g').attr("class", "axis") 
                                                        .attr("id", "yAxisTime") 
                                                        .attr("transform", "translate("+paddingXTime+","+paddingYTime+")") 
                                                        .call(yAxisTime.tickSize(-(widthTime-paddingXright),0,0));         
                                                        
                                                                                        
                                                
                                
                        
                        dataValues1 = flow0; //imports - teal 
                        dataValues2 = flow1; //exports - blue 
                        dataValues3 = flow2; 
                        
                        catLabels = dvc.flowdata.ons.timeLabels; 
                                                                        
                         line1 =d3.svg.line() 
                                                         .interpolate("monotone") 
                                                        .defined(function(d){ return d != null;}) 
                                                        .x(function(dataValues1,i) { 
                                                                        return xScaleTime(catLabels[i]); 
                                                        }) 
                                                        .y(function(catLabels,i) { 
                                                                        return yScaleTime(dataValues1[i]); 
                                                        }); 
                                                
                                                
                                                
                                                mainTimeChart.append("path") 
                                                        .attr("id","line1") 
                                                        .attr("d", line1(dataValues1)) 
                                                        .attr("stroke", dvc.flowdata.ons.dataTypeColour[0]) 
                                                        .attr("stroke-width","2px") 
                                                        .attr("fill","none") 
                                                        .attr("transform", "translate("+paddingXTime+","+paddingYTime+")");                                                 
                                                                        
                                                //mainTimeChart.append('g') 
//                                                .selectAll("circle") 
//                                                .data(dataValues1) 
//                                                .enter() 
//                                                .append("circle") 
//                                                .attr("class", "circles1") 
//                                                        .attr("stroke", dvc.flowdata.ons.dataTypeColour[0]) 
//                                                        .attr("stroke-width","2px") 
//                                                        .attr("fill","#fff") 
//                                                        .attr("cx", function(d,i){ 
//                                                                                        return xScaleTime(catLabels[i]) 
//                                                                }) 
//                                                        .attr("cy",function(d) { 
//                                                                                        return yScaleTime(prefix.scale(d)); 
//                                                                }) 
//                                                        .attr("r",function(d){return d ==null ? 0 : 3}) //if d = null then give a radius of 0, else return a radius of 3. 
//                                                        .attr("transform", "translate("+paddingXTime+","+paddingYTime+")"); 
                                                
//                                                mainTimeChart.append("g").selectAll("text") 
//                                                .data(dataValues1) 
//                                                .enter() 
//                                                .append("text") 
//                                                        .attr("x",  function(d,i){ 
//                                                                                        return xScale(catLabels[i]) 
//                                                                }) 
//                                                        .attr("class", "axisText") 
//                                                        .attr("y", function(d){ 
//                                                                 return yScale(0) 
//                                                                })         
//                                                        .attr("transform", "translate("+paddingX+","+(paddingY+25)+")")         
//                                                        .text(function(d,i){ 
//                                                                        if(catLabels.length>8){                                                                 
//                                                                                return i % 2 ? null : chartData.catLabels[i] ;         
//                                                                        } else { 
//                                                                                return  chartData.catLabels[i] 
//                                                                        } 
//                                                                         
//                                                                }); 
                                                        
                                                
                                line2 =d3.svg.line() 
                                                        .interpolate("monotone") 
                                                        .defined(function(d){ return d != null;}) 
                                                        .x(function(dataValues2,i) { 
                                                                        return xScaleTime(catLabels[i]); 
                                                        }) 
                                                        .y(function(catLabels,i) { 
                                                                        return yScaleTime(dataValues2[i]); 
                                                }); 
                                                
                                                
                                                
                                                mainTimeChart.append("path") 
                                                        .attr("id","line2") 
                                                        .attr("d", line2(dataValues2)) 
                                                        .attr("stroke", dvc.flowdata.ons.dataTypeColour[1]) 
                                                        .attr("stroke-width","2px") 
                                                        .attr("fill","none") 
                                                        .attr("transform", "translate("+paddingXTime+","+paddingYTime+")");                                                 
                                                                        
                                                                        
//                                                mainTimeChart.append('g') 
//                                                .selectAll("circle") 
//                                                .data(dataValues2) 
//                                                .enter() 
//                                                .append("circle") 
//                                                .attr("stroke", dvc.flowdata.ons.dataTypeColour[1]) 
//                                                .attr("stroke-width","2px") 
//                                                .attr("fill","#fff") 
//                                                .attr("class", "circles2") 
//                                                        .attr("cx", function(d,i){ 
//                                                                                        return xScaleTime(catLabels[i]) 
//                                                                }) 
//                                                        .attr("cy",function(d) { 
//                                                                                        return yScaleTime(prefix.scale(d)); 
//                                                                }) 
//                                                        .attr("r",function(d){ return d ==null ? 0 : 3}) 
//                                                        .attr("transform", "translate("+paddingXTime+","+paddingYTime+")");         
//                                                         
                                                        
                                                
                                                                                                
                                                                                
//                                                         
//                                mainTimeChart.append("g").append("text") 
//                                                .attr("class","chartUnits") 
//                                                .text(chartData.units) 
//                                                .attr("transform", "translate("+15+","+45+")") 
//                                                 
//                                mainTimeChart.append("g").append("text") 
//                                                .attr("class","key") 
//                                                .text(chartData.topic[0]) 
//                                                .attr("transform", "translate("+330+","+200+")") 
//                                                 
//                                if(chartData.topic[0]=="Male"){ mainTimeChart.append("rect").attr("x", 365) 
//                                                                                                        .attr("y", 195) 
//                                                                                                        .attr("width", 20) 
//                                                                                                        .attr("height", 3) 
//                                                                                                        .attr("fill", "#FC3"); 
//                                                                                                } 
//                                                                                                                                                 
//                                mainTimeChart.append("g").append("text") 
//                                                .attr("class","key") 
//                                                .text(chartData.topic[1]) 
//                                                .attr("transform", "translate("+335+","+225+")") 
//                                                 
//                                if(chartData.topic[1]=="Female"){ mainTimeChart.append("rect").attr("x", 365) 
//                                                                                                        .attr("y", 220) 
//                                                                                                        .attr("width", 20) 
//                                                                                                        .attr("height", 3) 
//                                                                                                        .attr("fill", "#6C9"); 
//                                                                                                } 
//                                                         
//                         
                        
                        
        
                        var leftText = [dvc.units, Math.round(dataValues1[dvc.timeIndex]*10/10, Math.round(dataValues2[dvc.timeIndex]*10)/10, Math.round(dataValues3[dvc.timeIndex])*10)/10]; 
                        
                        updateleft(leftText); 
                        
                        } 
                        
                        else { 
                                updateTimeChart(flow0,flow1,flow2); 
                                var leftText = [dvc.units, Math.round(dataValues1[dvc.timeIndex]*10)/10, Math.round(dataValues2[dvc.timeIndex]*10)/10, Math.round(dataValues3[dvc.timeIndex]*10)/10]; 
                                updateleft(leftText); 
                        } 
                                                
                }//end of makeTimeChart 

                function updateTimeChart (flow0, flow1, flow2) { 
                                
                        maxIn=d3.max(flow0); 
                        maxOut=d3.max(flow1); 
                        maxOv=d3.max([maxIn, maxOut]);         
                                
                                                
                        yScaleTime=d3.scale.linear() 
                                .domain([0,maxOv]) 
                                .range([heightTime,0]) 
                                .nice();         

                                                                        
                        xAxisTime=d3.svg.axis() 
								.scale(xScaleTime) 
								.orient("bottom") 
							  //.tickFormat(formatxAxisTime) 
							    .tickValues(xScaleTime.domain().filter(function(d, i) { return !(i % 2); }));         
                                
                        yAxisTime=d3.svg.axis() 
                                                        .scale(yScaleTime) 
                                                        .orient("left") 
                                                        .ticks(5); 
                                
                        mainTimeChart.select(".yLabel") 
                                  .text(dvc.yaxisSize);                                         
                                        
                
                        dataValues1 = flow0; //imports - teal 
                        dataValues2 = flow1; //exports - blue 
                        dataValues3 = flow2; 
                        
                                                      
                        mainTimeChart.select("#line1").attr("d",line1(dataValues1)); 
                        mainTimeChart.select("#line2").attr("d",line2(dataValues2)); 
                        mainTimeChart.select("#yAxisTime").call(yAxisTime.tickSize(-(widthTime-paddingXright),0,0)); 
                } 




		function highmatch(curr) {
				
				dvc.currentbar = d3.select(curr).attr("id").substring(3,5);		
				appendarc();
				
		}
		
		function appendarc () {
				dvc.curr = d3.select("#" + dvc.currentbar);
				dvc.curr.attr("class","polyhigh");
				dvc.arc = d3.select("#arc" + dvc.currentbar);
				dvc.currclass = dvc.arc.attr("class");
				dvc.arc.attr("class", dvc.currclass + " mapArcsSel");
//				dvc.arc = arcs.append("path")
//				  .attr("d", d3.select("#arc" + dvc.currentbar).attr("d"))
//				  .attr("id", "arcSelection")
//				  .attr("pointer-events", "none")
//				  .style("fill", "none")
//				  .style("stroke", "rgb(255, 127, 0)")
//				  .style("stroke-width", 3);
		
		
				var position = dvc.flowdata.ons.area.indexOf(dvc.currentbar);
				dvc.areaname = dvc.flowdata.ons.areaname[position];
				d3.select("#arealab").html(dvc.fixareaname + "<span style='font-size:18px;'> trade with</span> " + dvc.areaname);
				makeTimeChart(dvc.flow0time[position],dvc.flow1time[position],dvc.flow2time[position]);
				
		}
		
		function unhighmatch() {
				dvc.curr.attr("class","mapPoly");
				dvc.arc.attr("class", dvc.currclass);
				//d3.select("#mainTimeChart").remove();
				
		}

		function updateleft (leftText) {
			
				
				for(var i = 0; i < dvc.flowdata.ons.dataType.length; i++) {
					
					if(leftText[i+1]>=0) {
					
					$('#leftfig' + i).countTo({
						from: Math.round($('#leftfig' + i).text()),
						to: leftText[i+1],
						speed: 500,
						refreshInterval: 50,
					});
					
					$('#leftfigprefix' + i).text("£");
					
					} else {
					$('#leftfig' + i).countTo({
						from: Math.round($('#leftfig' + i).text()),
						to: Math.abs(leftText[i+1]),
						speed: 500,
						refreshInterval: 50,
					});
					
					$('#leftfigprefix' + i).text("-£");
						
					
					
					}
					
				}		
				
				d3.selectAll(".leftunit")
				.text(leftText[0]);
				
		
						
	//    $('.leftFigures').countTo({
//            from: $('.leftFigures').text(),
//            to: leftText[1],
//            speed: 2000,
//            refreshInterval: 50,
//            onComplete: function(value) {
//                console.debug(this);
//            }
//        });

	
	
		}

	





	
	
/* Swiper controls */

  var mySwiper = new Swiper('.swiper-container',{
    pagination: '.pagination',
    loop:false,
    grabCursor: true,
    paginationClickable: true,
	hashNav: true
  })
  $('.arrow-left').on('click', function(e){
    e.preventDefault()
    mySwiper.swipePrev()
	projectionprev()
  })
  $('.arrow-right').on('click', function(e){
    e.preventDefault()
    mySwiper.swipeNext()
	projectionnext()
  })
  $('.close').on('click', function(){
	  $(".device").hide();
	  //$("#toppanel").show("slide", {direction: "top" },"slow");
	  $("#controls").show("slide", {direction: "right" },"slow");
	  //$("#flowtype").show();
	  $("#panel").show("slide", {direction: "top" },"slow");
	  timeSlider()
	  $("#sliderTime").show("slide", {direction: "left" },"slow");
	  //$("#curryear").show("slide", {direction: "left" },"slow");
	  dvc.storyover=true;
         
		//setTimeout(function(){ sel(dvc.preselect)}, 2400); 
        //setTimeout(function(){ fixSpider(dvc.preselect)}, 2400); 
	
	  //defaultRotate();
	  trans();
	/*changeprojectiontonaturalearth*/
	/*And show the 'show story" interface*/
  });

/* End swiper controls */



	function requestFullScreen() {
			/* the element you want to make full screen */
			var element = document.getElementById("container");
			// Supports most browsers and their versions.
			var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullScreen;
		
			if (requestMethod) { // Native full screen.
				requestMethod.call(element);
			} else if (typeof window.ActiveXObject !== "undefined") { // Older IE.
				var wscript = new ActiveXObject("WScript.Shell");
				if (wscript !== null) {
					wscript.SendKeys("{F11}");
				}
			}
		}
		
		  
 	/* Social stuff */
		
		
		function makeFace()
		{

			var face = 'http://www.facebook.com/share.php?u=' + window.location.href;
			window.open(face);
		}
		
		
		function post2Twitter()

		{
			var myLoc = "of England & Wales";
			var myString="http://twitter.com/home?status="+escape("How do your earnings compare in your area? #earnings #map "+ window.location.href +" via @statisticsONS #ons");
			window.open(myString);
		}


		function showEmbed()
		{
			$('#embedurl').val('<iframe width=940 height=660 src="' + document.URL + '" scrolling=no frameborder=0/>');
			$('#embedbox').show(400);
		}

		function embedHide()
		{
			$('#embedbox').hide(400);
		}

   			
			

		

		// Make the body go full screen.
//requestFullScreen(elem);




</script>

</body>
</html>